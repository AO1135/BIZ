<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Indent — チェックリスト（OCR安定化版）</title>
<style>
  :root{--bg:#fff;--fg:#000}
  body{font-family:"Noto Sans JP",system-ui,Arial;margin:0;background:var(--bg);color:var(--fg);-webkit-tap-highlight-color:transparent}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #ddd}
  h1{font-size:18px;margin:0}
  main{padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,button,select,textarea{font-size:16px;padding:8px;border:1px solid #111;border-radius:8px;box-sizing:border-box}
  button{background:#000;color:#fff;cursor:pointer}
  .hidden{display:none}
  nav{position:fixed;left:0;right:0;bottom:0;display:flex;background:#000}
  nav button{flex:1;padding:12px;border:none;color:#fff;background:#000}
  .list-item{border:1px solid #111;padding:8px;margin-bottom:8px;border-radius:8px;display:flex;gap:8px;align-items:center;flex-wrap:nowrap}
  .code{font-weight:600;min-width:110px}
  .memoSmall{font-size:14px;width:180px;padding:6px}
  .small{font-size:13px;padding:6px}
</style>
<!-- Tesseract.js -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
<header>
  <h1 id="title">パスワード入力</h1>
  <button id="langBtn" class="small">日本語 / English</button>
</header>

<main>
  <!-- Password -->
  <section id="page-password">
    <div class="row">
      <input id="passwordInput" type="password" placeholder="パスワードを入力" />
      <button id="passwordSubmit">ログイン</button>
    </div>
    <p id="passwordError" style="color:red;display:none">パスワードが違います</p>
  </section>

  <!-- Login -->
  <section id="page-login" class="hidden">
    <div class="row">
      <input id="userIdInput" placeholder="ユーザーIDを入力" />
      <button id="loginSubmit">ログイン</button>
    </div>
  </section>

  <!-- Wait list -->
  <section id="page-wait" class="hidden">
    <h2 id="waitTitle">チェック待ちリスト</h2>

    <div class="row" style="margin-bottom:8px">
      <input id="productCodeInput_wait" placeholder="7桁のコード (手入力/バーコード)" />
      <input id="productQtyInput_wait" type="number" min="1" value="1" style="width:90px" />
      <input id="productMemoInput_wait" placeholder="メモ（1行）" style="width:180px" />
      <button id="addProductBtn_wait">追加（一時）</button>
    </div>

    <div class="row" style="margin-bottom:8px">
      <button id="ocrCaptureBtn">📷 撮影してOCR</button>
      <input id="ocrInput" type="file" accept="image/*" capture="environment" class="hidden" />
      <input id="groupNameInput" placeholder="グループ名" style="width:160px"/>
      <button id="groupCreateBtn">選択をグループ化</button>
    </div>

    <p style="margin:6px 0;color:#666">※ 選択して「決定」でチェックリストへ移動します。</p>

    <div id="waitList"></div>

    <div class="row" style="margin-top:8px">
      <button id="decideBtn">選択商品をチェックリストに決定</button>
      <button id="resetWaitBtn">チェック待ちリストをリセット</button>
      <button id="resetAllBtn">全データをリセット</button>
    </div>
  </section>

  <!-- Ready list -->
  <section id="page-ready" class="hidden">
    <h2 id="readyTitle">チェックリスト</h2>
    <div class="row" style="margin-bottom:8px">
      <input id="scanInputReady" placeholder="バーコード / 手入力でチェック（Enter）" style="flex:1" />
      <button id="scanBtnReady">チェック実行</button>
      <button id="toCheckedPage">チェック済みを表示</button>
    </div>
    <div id="readyList"></div>
  </section>

  <!-- Checked list -->
  <section id="page-checked" class="hidden">
    <h2 id="checkedTitle">チェック済みリスト</h2>
    <div id="checkedList"></div>
    <div style="margin-top:8px">
      <button id="resetCheckedBtn">チェック済みリストをリセット</button>
    </div>
  </section>
</main>

<nav>
  <button id="navChecklist">📋 チェック待ち</button>
  <button id="navReady">📝 チェックリスト</button>
  <button id="navChecked">✅ チェック済み</button>
</nav>

<script>
/* ================== 設定・データ ================== */
const PASSWORD = "0509";
let lang = "ja";
let isPasswordOk = false;
let isLoginOk = false;

let waitList = JSON.parse(localStorage.getItem("indent:waitList")||"[]");
let readyList = JSON.parse(localStorage.getItem("indent:readyList")||"[]");
let checkedList = JSON.parse(localStorage.getItem("indent:checkedList")||"[]");

function saveAll(){
  localStorage.setItem("indent:waitList", JSON.stringify(waitList));
  localStorage.setItem("indent:readyList", JSON.stringify(readyList));
  localStorage.setItem("indent:checkedList", JSON.stringify(checkedList));
}

/* ================== 文言 ================== */
const texts = {
  ja: {
    waitTitle: "チェック待ちリスト",
    readyTitle: "チェックリスト",
    checkedTitle: "チェック済みリスト",
    add_temp: "追加（一時）",
    ocr: "📷 撮影してOCR",
    group_create: "選択をグループ化",
    decide: "選択商品をチェックリストに決定",
    reset_wait: "チェック待ちリストをリセット",
    reset_all: "全データをリセット",
    reset_checked: "チェック済みリストをリセット",
    enter_password: "パスワードを入力",
    login: "ログイン",
    pass_required: "パスワードを先に突破してください",
    enter_id_alert: "IDを入力してください",
    code7: "7桁のコードを入力してください",
    copied: "コピーしました",
    ocrAdded: "OCRで追加しました",
    ocrError: "OCRに失敗しました（ネットワーク/メモリ問題の可能性）",
    ocrRetry: "OCRを言語少なくして再試行します...",
    no_hit: "該当なし",
    decide_ok: "チェックリストに移しました",
    memo_placeholder: "メモ（1行）",
    scan_placeholder: "バーコード / 手入力でチェック（Enter）"
  },
  en: {
    waitTitle: "Waiting list",
    readyTitle: "Checklist",
    checkedTitle: "Checked items",
    add_temp: "Add (temp)",
    ocr: "📷 Capture & OCR",
    group_create: "Group selected",
    decide: "Decide selected → Checklist",
    reset_wait: "Reset waiting list",
    reset_all: "Reset all data",
    reset_checked: "Reset checked list",
    enter_password: "Enter Password",
    login: "Login",
    pass_required: "Please enter password first",
    enter_id_alert: "Please enter ID",
    code7: "Please enter 7 digits code",
    copied: "Copied",
    ocrAdded: "Added via OCR",
    ocrError: "OCR failed (possible memory/network issue)",
    ocrRetry: "Retrying OCR with fewer languages...",
    no_hit: "No match",
    decide_ok: "Moved to checklist",
    memo_placeholder: "Memo (1 line)",
    scan_placeholder: "Scan or type code (Enter)"
  }
};

/* ================== ピッ音 ================== */
let audioCtx;
function playBeep(){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "square";
    o.frequency.value = 1400;
    g.gain.value = 0.0015;
    o.connect(g);
    g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>o.stop(), 80);
  }catch(e){ console.warn("Audio err", e); }
}

/* ================== DOM refs ================== */
const dom = {
  title: document.getElementById("title"),
  pagePassword: document.getElementById("page-password"),
  pageLogin: document.getElementById("page-login"),
  pageWait: document.getElementById("page-wait"),
  pageReady: document.getElementById("page-ready"),
  pageChecked: document.getElementById("page-checked"),
  waitListEl: document.getElementById("waitList"),
  readyListEl: document.getElementById("readyList"),
  checkedListEl: document.getElementById("checkedList"),
  passwordInput: document.getElementById("passwordInput"),
  passwordSubmit: document.getElementById("passwordSubmit"),
  userIdInput: document.getElementById("userIdInput"),
  loginSubmit: document.getElementById("loginSubmit"),
  ocrInput: document.getElementById("ocrInput"),
  ocrCaptureBtn: document.getElementById("ocrCaptureBtn"),
  productCodeInput_wait: document.getElementById("productCodeInput_wait"),
  productQtyInput_wait: document.getElementById("productQtyInput_wait"),
  productMemoInput_wait: document.getElementById("productMemoInput_wait"),
  addProductBtn_wait: document.getElementById("addProductBtn_wait"),
  groupNameInput: document.getElementById("groupNameInput"),
  groupCreateBtn: document.getElementById("groupCreateBtn"),
  decideBtn: document.getElementById("decideBtn"),
  scanInputReady: document.getElementById("scanInputReady"),
  scanBtnReady: document.getElementById("scanBtnReady"),
  toCheckedPage: document.getElementById("toCheckedPage")
};

/* ================== UI 更新 ================== */
function updateLangUI(){
  document.getElementById("waitTitle").textContent = texts[lang].waitTitle;
  document.getElementById("readyTitle").textContent = texts[lang].readyTitle;
  document.getElementById("checkedTitle").textContent = texts[lang].checkedTitle;
  document.getElementById("addProductBtn_wait").textContent = texts[lang].add_temp;
  document.getElementById("ocrCaptureBtn").textContent = texts[lang].ocr;
  document.getElementById("groupCreateBtn").textContent = texts[lang].group_create;
  document.getElementById("decideBtn").textContent = texts[lang].decide;
  document.getElementById("resetWaitBtn").textContent = texts[lang].reset_wait;
  document.getElementById("resetAllBtn").textContent = texts[lang].reset_all;
  document.getElementById("resetCheckedBtn").textContent = texts[lang].reset_checked;
  dom.productCodeInput_wait.placeholder = texts[lang].scan_placeholder;
  dom.productMemoInput_wait.placeholder = texts[lang].memo_placeholder;
  dom.scanInputReady.placeholder = texts[lang].scan_placeholder;
}

function showPage(id){
  if(id !== "page-password" && id !== "page-login"){
    if(!isPasswordOk || !isLoginOk){
      alert(texts[lang].pass_required);
      return;
    }
  }
  ["page-password","page-login","page-wait","page-ready","page-checked"].forEach(pid=>document.getElementById(pid).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  if(id === "page-wait") dom.title.textContent = texts[lang].waitTitle;
  if(id === "page-ready") dom.title.textContent = texts[lang].readyTitle;
  if(id === "page-checked") dom.title.textContent = texts[lang].checkedTitle;
  if(id === "page-password") dom.title.textContent = texts[lang].enter_password;
  if(id === "page-login") dom.title.textContent = texts[lang].login;
  updateLangUI(); renderAll();
}

function renderWaitList(){
  const el = dom.waitListEl; el.innerHTML = "";
  waitList.forEach((it,i)=>{
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `
      <input type="checkbox" class="selectItem" data-i="${i}" />
      <div class="code">${it.code}</div>
      <input class="memoSmall" data-i="${i}" value="${it.memo||''}" placeholder="${texts[lang].memo_placeholder}" />
      <input class="small qtyWait" data-i="${i}" value="${it.qty||1}" type="number" min="1" style="width:80px" />
      <div style="min-width:120px">${it.group?('['+it.group+']'):""}</div>
      <button class="copyBtn small" data-code="${it.code}">コピー</button>
    `;
    el.appendChild(div);
  });
  // handlers
  el.querySelectorAll(".copyBtn").forEach(b=> b.onclick = (e)=>{ navigator.clipboard.writeText(e.target.dataset.code); alert(texts[lang].copied); });
  el.querySelectorAll(".qtyWait").forEach(inp=> inp.onchange = ()=>{ const idx = Number(inp.dataset.i); waitList[idx].qty = Math.max(1, Number(inp.value)||1); saveAll(); });
  el.querySelectorAll(".memoSmall").forEach(inp=> inp.oninput = ()=>{ const idx = Number(inp.dataset.i); waitList[idx].memo = inp.value; saveAll(); });
}

function renderReadyList(){
  const el = dom.readyListEl; el.innerHTML = "";
  readyList.forEach((it,i)=>{
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `
      <div class="code">${it.code} ${it.group?('['+it.group+']'):""}</div>
      <input class="small readyQty" data-i="${i}" value="${it.qty||1}" type="number" min="1" style="width:80px" />
      <input class="memoSmall readyMemo" data-i="${i}" value="${it.memo||''}" placeholder="${texts[lang].memo_placeholder}" />
      <button class="checkBtn small" data-i="${i}">✔</button>
    `;
    el.appendChild(div);
  });
  // attach handlers
  el.querySelectorAll(".checkBtn").forEach(b=>{
    b.onclick = (e)=>{
      const i = Number(e.target.dataset.i);
      if(i<0 || i>=readyList.length) return;
      const item = readyList[i];
      checkedList.push({code:item.code, qty:1, memo:item.memo, group:item.group});
      item.qty = Number(item.qty) - 1;
      if(item.qty <= 0) readyList.splice(i,1);
      saveAll(); renderAll(); playBeep();
    };
  });
  el.querySelectorAll(".readyQty").forEach(inp=> inp.onchange = ()=>{ const i = Number(inp.dataset.i); readyList[i].qty = Math.max(1, Number(inp.value)||1); saveAll(); renderReadyList(); });
  el.querySelectorAll(".readyMemo").forEach(inp=> inp.oninput = ()=>{ const i = Number(inp.dataset.i); readyList[i].memo = inp.value; saveAll(); });
}

function renderCheckedList(){
  const el = dom.checkedListEl; el.innerHTML = "";
  const summary = {};
  checkedList.forEach(it=>{
    if(!summary[it.code]) summary[it.code] = {qty:0, memo: it.memo||"", group: it.group||""};
    summary[it.code].qty += Number(it.qty||1);
  });
  Object.keys(summary).forEach(code=>{
    const it = summary[code];
    const div = document.createElement("div");
    div.className = "list-item";
    div.textContent = `${code} ×${it.qty}` + (it.memo?(' ('+it.memo+')'):"") + (it.group?(' ['+it.group+']'):"");
    el.appendChild(div);
  });
}

function renderAll(){ renderWaitList(); renderReadyList(); renderCheckedList(); }

/* ================== 言語切替・認証・ナビ ================== */
document.getElementById("langBtn").addEventListener("click", ()=>{ lang = (lang==="ja" ? "en" : "ja"); updateLangUI(); renderAll(); });

document.getElementById("passwordSubmit").addEventListener("click", ()=>{
  const v = dom.passwordInput.value.trim();
  if(v === PASSWORD){ isPasswordOk = true; showPage("page-login"); }
  else{ document.getElementById("passwordError").style.display = "block"; setTimeout(()=>document.getElementById("passwordError").style.display="none",2000); }
});

document.getElementById("loginSubmit").addEventListener("click", ()=>{
  if(!isPasswordOk) return alert(texts[lang].pass_required);
  const id = dom.userIdInput.value.trim();
  if(!id) return alert(texts[lang].enter_id_alert);
  localStorage.setItem("indent:user", id);
  isLoginOk = true;
  showPage("page-wait");
});

document.getElementById("navChecklist").addEventListener("click", ()=> showPage("page-wait"));
document.getElementById("navReady").addEventListener("click", ()=> showPage("page-ready"));
document.getElementById("navChecked").addEventListener("click", ()=> showPage("page-checked"));

/* ================== チェック待ち操作: 追加・OCR・グループ化・決定 ================== */
document.getElementById("addProductBtn_wait").addEventListener("click", ()=>{
  if(!isLoginOk) return alert(texts[lang].pass_required);
  const code = dom.productCodeInput_wait.value.trim();
  const qty = Math.max(1, Number(dom.productQtyInput_wait.value) || 1);
  const memo = dom.productMemoInput_wait.value.trim();
  if(!/^\d{7}$/.test(code)) return alert(texts[lang].code7);
  waitList.push({code, qty, memo, group: ""});
  saveAll(); renderWaitList();
  dom.productCodeInput_wait.value = ""; dom.productMemoInput_wait.value = "";
});

/* ========== OCR: worker を使い回す（安定化） ========== */
let tesseractWorker = null;
let ocrInProgress = false;

// create or get worker
async function getWorker(){
  if(tesseractWorker) return tesseractWorker;
  tesseractWorker = Tesseract.createWorker({
    logger: m => console.log("Tesseract:", m)
  });
  try{
    await tesseractWorker.load();
    // try to load both languages; may fail on low-memory devices — we'll handle fallback
    await tesseractWorker.loadLanguage('eng+jpn');
    await tesseractWorker.initialize('eng+jpn');
  }catch(err){
    console.warn("eng+jpn load failed:", err);
    try{
      // fallback: load only english
      await tesseractWorker.loadLanguage('eng');
      await tesseractWorker.initialize('eng');
    }catch(err2){
      console.error("Fallback OCR init failed:", err2);
      throw err2;
    }
  }
  return tesseractWorker;
}

// OCR button -> file input
document.getElementById("ocrCaptureBtn").addEventListener("click", ()=> document.getElementById("ocrInput").click());

document.getElementById("ocrInput").addEventListener("change", async (e)=>{
  if(!isLoginOk) return alert(texts[lang].pass_required);
  const file = e.target.files[0];
  e.target.value = "";
  if(!file) return;
  if(ocrInProgress) return alert("OCR is busy, please wait");
  ocrInProgress = true;
  try{
    // load image and draw into canvas (full image to avoid crop modal issues)
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.src = url;
    await new Promise(r=> img.onload = r);
    const canvas = document.createElement("canvas");
    canvas.width = img.width; canvas.height = img.height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    // small downscale to reduce memory if very large
    const MAX_PIX = 1600;
    let outCanvas = canvas;
    if(Math.max(canvas.width, canvas.height) > MAX_PIX){
      const scale = MAX_PIX / Math.max(canvas.width, canvas.height);
      const c2 = document.createElement("canvas");
      c2.width = Math.round(canvas.width * scale);
      c2.height = Math.round(canvas.height * scale);
      c2.getContext("2d").drawImage(canvas, 0, 0, c2.width, c2.height);
      outCanvas = c2;
    }
    // blob
    const blob = await new Promise(res=> outCanvas.toBlob(res, "image/png"));
    URL.revokeObjectURL(url);

    // OCR: try worker (eng+jpn preferred, fallback to eng)
    try{
      // show progress note
      alert("OCR中...（少し時間がかかります）");
      const worker = await getWorker();
      const res = await worker.recognize(blob);
      const text = res?.data?.text || "";
      const codes = (text.match(/\b\d{7}\b/g)) || [];
      if(codes.length === 0){
        alert(texts[lang].no_hit);
      } else {
        codes.forEach(c => waitList.push({code:c, qty:1, memo:"", group:""}));
        saveAll(); renderWaitList();
        alert(texts[lang].ocrAdded);
      }
    }catch(ocrErr){
      console.warn("OCR primary error:", ocrErr);
      // try fallback: re-init worker with eng only if eng+jpn failed earlier
      try{
        alert(texts[lang].ocrRetry);
        if(tesseractWorker){
          await tesseractWorker.terminate();
          tesseractWorker = null;
        }
        const w2 = Tesseract.createWorker({logger: m => console.log("Tesseract fallback:", m)});
        await w2.load();
        await w2.loadLanguage('eng');
        await w2.initialize('eng');
        const res2 = await w2.recognize(blob);
        await w2.terminate();
        const text2 = res2?.data?.text || "";
        const codes2 = (text2.match(/\b\d{7}\b/g)) || [];
        if(codes2.length === 0){
          alert(texts[lang].no_hit);
        } else {
          codes2.forEach(c => waitList.push({code:c, qty:1, memo:"", group:""}));
          saveAll(); renderWaitList();
          alert(texts[lang].ocrAdded);
        }
      }catch(finalErr){
        console.error("OCR fallback failed:", finalErr);
        alert(texts[lang].ocrError);
      }
    }
  }catch(err){
    console.error("OCR outer error:", err);
    alert(texts[lang].ocrError);
  }finally{
    ocrInProgress = false;
  }
});

/* ========== group & decide ========== */
document.getElementById("groupCreateBtn").addEventListener("click", ()=>{
  const g = document.getElementById("groupNameInput").value.trim();
  if(!g) return alert(texts[lang].enter_group_name || "グループ名を入力してください");
  const boxes = Array.from(document.querySelectorAll(".selectItem:checked")).map(n=>Number(n.dataset.i));
  if(boxes.length === 0) return alert("No items selected");
  boxes.forEach(i => { if(waitList[i]) waitList[i].group = g; });
  saveAll(); renderWaitList(); document.getElementById("groupNameInput").value = "";
});

document.getElementById("decideBtn").addEventListener("click", ()=>{
  const checkedBoxes = Array.from(document.querySelectorAll(".selectItem:checked"));
  if(checkedBoxes.length === 0) return alert("No items selected");
  const indices = checkedBoxes.map(cb=>Number(cb.dataset.i)).sort((a,b)=>b-a);
  indices.forEach(i => { readyList.push({...waitList[i]}); waitList.splice(i,1); });
  saveAll(); renderAll(); alert(texts[lang].decide_ok);
});

/* ========== reset handlers ========== */
document.getElementById("resetWaitBtn").addEventListener("click", ()=> { if(!confirm("Reset waiting list?")) return; waitList = []; saveAll(); renderAll(); });
document.getElementById("resetAllBtn").addEventListener("click", ()=> { if(!confirm("Reset ALL data?")) return; waitList=[]; readyList=[]; checkedList=[]; saveAll(); renderAll(); });
document.getElementById("resetCheckedBtn").addEventListener("click", ()=> { if(!confirm("Reset checked list?")) return; checkedList=[]; saveAll(); renderAll(); });

/* ========== ready list: check via input or button ========== */
document.getElementById("scanBtnReady").addEventListener("click", ()=> handleScanCode(dom.scanInputReady.value.trim()));
dom.scanInputReady.addEventListener("keypress", (e)=>{ if(e.key === "Enter"){ handleScanCode(e.target.value.trim()); e.target.value=""; }});

function handleScanCode(code){
  if(!isLoginOk) return alert(texts[lang].pass_required);
  if(!code) return;
  const idx = readyList.findIndex(it => it.code === code);
  if(idx === -1) return alert(texts[lang].no_hit);
  const item = readyList[idx];
  // move one unit
  checkedList.push({code:item.code, qty:1, memo:item.memo, group:item.group});
  item.qty = Number(item.qty) - 1;
  if(item.qty <= 0) readyList.splice(idx,1);
  saveAll(); renderAll(); playBeep();
}

/* ========== initial render ========== */
function init(){
  updateLangUI();
  renderAll();
  showPage("page-password");
}
init();

</script>
</body>
</html>
