<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Indent — チェックリスト</title>
<style>
body { font-family:'Noto Sans JP',sans-serif; margin:0; background:#fff; color:#000; }
header { display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #ccc; }
h1 { font-size:18px; margin:0; }
main { padding:12px; }
button, input { font-size:16px; padding:6px; border:1px solid #000; border-radius:6px; box-sizing:border-box; }
button { background:#000; color:#fff; cursor:pointer; }
nav { position:fixed; bottom:0; left:0; right:0; display:flex; background:#000; }
nav button { flex:1; border:none; border-right:1px solid #fff; background:#000; color:#fff; padding:10px; }
nav button:last-child { border-right:none; }
.hidden { display:none; }
.list-item { border:1px solid #000; padding:6px; margin-bottom:6px; border-radius:6px; display:flex; flex-wrap:wrap; align-items:center; gap:6px; }
.list-item input[type="number"] { width:70px; }
.list-item input.memoInput { width:100px; }
.copyBtn { background:#fff; color:#000; border:1px solid #000; }
#cropCanvas { border:1px solid #000; max-width:100%; display:none; touch-action:none; }
</style>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
<header>
<h1 id="title">パスワード入力</h1>
<button type="button" id="langBtn">日本語 / English</button>
</header>

<main>
<section id="page-password">
<input id="passwordInput" type="password" placeholder="パスワードを入力" />
<button type="button" id="passwordSubmit">ログイン</button>
<p id="passwordError" style="color:red;display:none">パスワードが違います</p>
</section>

<section id="page-login" class="hidden">
<input id="userIdInput" placeholder="ユーザーIDを入力" />
<button type="button" id="loginSubmit">ログイン</button>
</section>

<section id="page-checklist" class="hidden">
<h2 id="checklistTitle">チェック待ちリスト</h2>
<div style="display:flex;gap:8px;margin-bottom:8px;">
<input id="productCodeInput" placeholder="7桁のコード" />
<input id="productQtyInput" type="number" min="1" value="1" />
<button type="button" id="addProductBtn">追加</button>
</div>
<div style="margin-bottom:8px;">
<button type="button" id="ocrCaptureBtn">📷 OCRで追加</button>
<input type="file" id="ocrInput" accept="image/*" capture="environment" class="hidden" />
</div>
<canvas id="cropCanvas"></canvas>
<div id="checklist"></div>
<button type="button" id="resetChecklistBtn" style="margin-top:8px;">チェック待ちリストをリセット</button>
<button type="button" id="resetAllBtn" style="margin-top:8px;">全データをリセット</button>
</section>

<section id="page-checked" class="hidden">
<h2 id="checkedTitle">チェック済みリスト</h2>
<div id="checkedList"></div>
<button type="button" id="resetCheckedBtn" style="margin-top:8px;">チェック済みリストをリセット</button>
</section>
</main>

<nav>
<button type="button" id="navChecklist">📋 チェック待ち</button>
<button type="button" id="navChecked">✅ チェック済み</button>
</nav>

<script>
document.addEventListener("DOMContentLoaded",()=>{

const PASSWORD="letmein123";
let currentPage="page-password";
let lang="ja";
let checklist=JSON.parse(localStorage.getItem("indent:checklist")||"[]");
let checkedList=JSON.parse(localStorage.getItem("indent:checkedList")||"[]");
let isPasswordOk=false;
let isLoginOk=false;

// --- テキスト ---
const texts={
ja:{ password:"パスワード入力", login:"ログイン", checklist:"チェック待ちリスト", checked:"チェック済みリスト", add:"追加" },
en:{ password:"Enter Password", login:"Login", checklist:"Checklist", checked:"Checked Items", add:"Add" }
};

// --- ページ切替 ---
function showPage(id){ 
  ["page-password","page-login","page-checklist","page-checked"].forEach(p=>document.getElementById(p).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  currentPage=id;
  if(id!=="page-password" && id!=="page-login") document.getElementById("title").textContent=texts[lang][id.replace("page-","")];
}

// --- 言語切替 ---
document.getElementById("langBtn").onclick=()=>{
  lang=(lang==="ja"?"en":"ja");
  showPage(currentPage);
};

// --- パスワード ---
document.getElementById("passwordSubmit").onclick=()=>{
  const val=document.getElementById("passwordInput").value;
  if(val===PASSWORD){
    isPasswordOk=true;
    showPage("page-login");
  } else {
    let err=document.getElementById("passwordError");
    err.style.display="block";
    setTimeout(()=>err.style.display="none",2000);
  }
};

// --- ログイン ---
document.getElementById("loginSubmit").onclick=()=>{
  if(!isPasswordOk) return alert(lang==="ja"?"パスワードを先に突破してください":"Please enter password first");
  const id=document.getElementById("userIdInput").value.trim();
  if(!id) return alert(lang==="ja"?"IDを入力してください":"Please enter ID");
  localStorage.setItem("indent:user",id);
  isLoginOk=true;
  showPage("page-checklist");
};

// --- 保存 ---
function saveData(){
  localStorage.setItem("indent:checklist",JSON.stringify(checklist));
  localStorage.setItem("indent:checkedList",JSON.stringify(checkedList));
}

// --- リスト描画 ---
function renderLists(){
  const checklistEl=document.getElementById("checklist");
  const checkedListEl=document.getElementById("checkedList");
  checklistEl.innerHTML="";
  checklist.forEach((item,i)=>{
    const div=document.createElement("div");
    div.className="list-item";
    div.innerHTML=`<span>${item.code}</span>
    <input type="number" min="1" value="${item.qty}" data-i="${i}" class="qtyInput"/>
    <input class="memoInput" type="text" placeholder="メモ" value="${item.memo||''}" data-i="${i}"/>
    <button type="button" class="copyBtn" data-code="${item.code}">コピー</button>
    <button type="button" class="checkBtn" data-i="${i}">✔</button>`;
    checklistEl.appendChild(div);
  });

  checklistEl.addEventListener("click",function(e){
    if(e.target.classList.contains("checkBtn")){
      const i = e.target.dataset.i;
      checkedList.push(checklist[i]);
      checklist.splice(i,1);
      saveData(); renderLists();
    }
    if(e.target.classList.contains("copyBtn")){
      navigator.clipboard.writeText(e.target.dataset.code);
      alert(lang==="ja"?"コピーしました":"Copied");
    }
  });

  document.querySelectorAll(".qtyInput").forEach(inp=>{
    inp.onchange=e=>{ checklist[e.target.dataset.i].qty=Number(e.target.value)||1; saveData(); };
  });
  document.querySelectorAll(".memoInput").forEach(inp=>{
    inp.oninput=e=>{ checklist[e.target.dataset.i].memo=e.target.value; saveData(); };
  });

  checkedListEl.innerHTML="";
  checkedList.forEach(item=>{
    const div=document.createElement("div");
    div.className="list-item";
    div.textContent=`${item.code} ×${item.qty} ${item.memo?('('+item.memo+')'):""}`;
    checkedListEl.appendChild(div);
  });
}

renderLists();

// --- 手入力追加 ---
document.getElementById("addProductBtn").onclick=()=>{
  if(!isLoginOk) return alert(lang==="ja"?"ログインしてください":"Please login");
  const code=document.getElementById("productCodeInput").value.trim();
  const qty=Number(document.getElementById("productQtyInput").value)||1;
  if(!/^\d{7}$/.test(code)) return alert(lang==="ja"?"7桁のコードを入力してください":"Please enter 7 digits code");
  checklist.push({code,qty,memo:""});
  saveData(); renderLists();
  document.getElementById("productCodeInput").value="";
};

// --- OCR + トリミング ---
const ocrInput = document.getElementById("ocrInput");
const cropCanvas = document.getElementById("cropCanvas");
let ctx=cropCanvas.getContext("2d");
let imgObj=new Image();
let startX=0, startY=0, endX=0, endY=0;
let isDrawing=false;

document.getElementById("ocrCaptureBtn").onclick = () => {
  if(!isLoginOk) return alert(lang==="ja"?"ログインしてください":"Please login");
  ocrInput.click();
};

ocrInput.onchange = (e) => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    imgObj.src = ev.target.result;
  }
  reader.readAsDataURL(file);
};

imgObj.onload = () => {
  cropCanvas.width=imgObj.width/2;
  cropCanvas.height=imgObj.height/2;
  ctx.drawImage(imgObj,0,0,cropCanvas.width,cropCanvas.height);
  cropCanvas.style.display="block";
};

// --- トリミング操作 ---
cropCanvas.addEventListener("pointerdown",e=>{
  isDrawing=true;
  const rect=cropCanvas.getBoundingClientRect();
  startX=e.clientX-rect.left; startY=e.clientY-rect.top;
});
cropCanvas.addEventListener("pointermove",e=>{
  if(!isDrawing) return;
  const rect=cropCanvas.getBoundingClientRect();
  endX=e.clientX-rect.left; endY=e.clientY-rect.top;
  ctx.drawImage(imgObj,0,0,cropCanvas.width,cropCanvas.height);
  ctx.strokeStyle="red"; ctx.lineWidth=2;
  ctx.strokeRect(startX,startY,endX-startX,endY-startY);
});
cropCanvas.addEventListener("pointerup",async e=>{
  if(!isDrawing) return;
  isDrawing=false;
  const cropWidth=endX-startX;
  const cropHeight=endY-startY;
  if(cropWidth<=0 || cropHeight<=0) return alert(lang==="ja"?"範囲を選択してください":"Select area");
  const croppedData=cropCanvas.getContext("2d").getImageData(startX,startY,cropWidth,cropHeight);
  const tmpCanvas=document.createElement("canvas");
  tmpCanvas.width=cropWidth; tmpCanvas.height=cropHeight;
  tmpCanvas.getContext("2d").putImageData(croppedData,0,0);
  // OCR実行
  const {data:{text}}=await Tesseract.recognize(tmpCanvas, 'eng+jpn', {logger:m=>console.log(m)});
  const matches=text.match(/\b\d{7}\b/g);
  if(!matches) return alert(lang==="ja"?"認識できませんでした":"No code detected");
  matches.forEach(code => checklist.push({code,qty:1,memo:""}));
  saveData(); renderLists();
  cropCanvas.style.display="none";
  alert(lang==="ja"?"OCRで追加しました":"Added via OCR");
  ocrInput.value="";
});

// --- リ
