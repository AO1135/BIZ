<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Indent â€” ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</title>
<style>
  :root{--black:#000;--white:#fff}
  body{font-family:Inter, "Noto Sans JP",system-ui, sans-serif;margin:0;background:var(--white);color:var(--black);-webkit-tap-highlight-color:transparent}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #ddd}
  h1{font-size:18px;margin:0}
  main{padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input, button, select, textarea{font-size:16px;padding:8px;border:1px solid #111;border-radius:8px;box-sizing:border-box}
  button{background:var(--black);color:var(--white);cursor:pointer}
  .hidden{display:none}
  nav{position:fixed;left:0;right:0;bottom:0;display:flex;background:var(--black)}
  nav button{flex:1;padding:12px;border:none;color:#fff;background:var(--black);font-size:16px}
  .list-item{border:1px solid #111;padding:8px;margin-bottom:8px;border-radius:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .list-item .code{font-weight:600;min-width:90px}
  .small{font-size:13px;padding:6px}
  #cropCanvas{max-width:100%;border:1px solid #111;display:none}
  .modal{position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center}
  .modal .card{background:#fff;padding:12px;border-radius:8px;max-width:420px;width:92%}
</style>

<!-- Tesseract.js -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
<header>
  <h1 id="title">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›</h1>
  <button id="langBtn" class="small">æ—¥æœ¬èª / English</button>
</header>

<main>
  <!-- Password -->
  <section id="page-password">
    <div class="row">
      <input id="passwordInput" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" />
      <button id="passwordSubmit">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    <p id="passwordError" style="color:red;display:none">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</p>
  </section>

  <!-- Login ID -->
  <section id="page-login" class="hidden">
    <div class="row">
      <input id="userIdInput" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›" />
      <button id="loginSubmit">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
  </section>

  <!-- Waiting / Pre-check list -->
  <section id="page-wait" class="hidden">
    <h2 id="waitTitle">ãƒã‚§ãƒƒã‚¯å¾…ã¡ãƒªã‚¹ãƒˆ</h2>

    <div class="row" style="margin-bottom:8px">
      <input id="productCodeInput_wait" placeholder="7æ¡ã®ã‚³ãƒ¼ãƒ‰ (æ‰‹å…¥åŠ› / ãƒãƒ¼ã‚³ãƒ¼ãƒ‰)" />
      <input id="productQtyInput_wait" type="number" min="1" value="1" style="width:90px" />
      <input id="productMemoInput_wait" placeholder="ãƒ¡ãƒ¢ï¼ˆ1è¡Œï¼‰" style="flex:1" />
      <button id="addProductBtn_wait">è¿½åŠ ï¼ˆä¸€æ™‚ï¼‰</button>
    </div>

    <div class="row" style="margin-bottom:8px">
      <button id="ocrCaptureBtn">ğŸ“· æ’®å½±ã—ã¦OCR</button>
      <input id="ocrInput" type="file" accept="image/*" capture="environment" class="hidden" />
      <button id="groupCreateBtn">ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆï¼ˆé¸æŠå•†å“ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼‰</button>
      <input id="groupNameInput" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—å" style="width:160px" />
    </div>

    <p style="margin:6px 0;color:#666" id="tempNote">â€» è¿½åŠ ã¯ã¾ãšã“ã“ã«ä¸€æ™‚ä¿å­˜ã•ã‚Œã¾ã™ã€‚é¸æŠã—ã¦ã€Œæ±ºå®šã€ã§ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã¸ç§»å‹•ã—ã¾ã™ã€‚</p>

    <div id="waitList"></div>

    <div class="row" style="margin-top:8px">
      <button id="decideBtn">é¸æŠå•†å“ã‚’ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã«æ±ºå®š</button>
      <button id="resetWaitBtn">ãƒã‚§ãƒƒã‚¯å¾…ã¡ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      <button id="resetAllBtn">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </section>

  <!-- Ready / Check list -->
  <section id="page-ready" class="hidden">
    <h2 id="readyTitle">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h2>

    <div class="row" style="margin-bottom:8px">
      <input id="scanInputReady" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ / æ‰‹å…¥åŠ›ã§ãƒã‚§ãƒƒã‚¯ï¼ˆEnterï¼‰" />
      <button id="scanBtnReady">ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ</button>
      <button id="toCheckedPage">ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã‚’è¡¨ç¤º</button>
    </div>

    <div id="readyList"></div>
  </section>

  <!-- Checked -->
  <section id="page-checked" class="hidden">
    <h2 id="checkedTitle">ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ãƒªã‚¹ãƒˆ</h2>
    <div id="checkedList"></div>
    <div style="margin-top:8px">
      <button id="resetCheckedBtn">ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </section>
</main>

<!-- modal for choosing count -->
<div id="countModal" class="hidden modal" aria-hidden="true">
  <div class="card">
    <div style="margin-bottom:8px">
      <div id="countModalText">å€‹æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      <input id="countModalInput" type="number" min="1" value="1" style="width:100%" />
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="countModalCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="countModalOk">OK</button>
    </div>
  </div>
</div>

<script>
/* =============== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ / åˆæœŸãƒ‡ãƒ¼ã‚¿ =============== */
const PASSWORD = "0509";
let lang = "ja"; // 'ja' or 'en'
let isPasswordOk = false;
let isLoginOk = false;

// ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢
let waitList = JSON.parse(localStorage.getItem("indent:waitList")||"[]");      // ãƒã‚§ãƒƒã‚¯å¾…ã¡ï¼ˆä¸€æ™‚å«ã‚€ï¼‰
let readyList = JSON.parse(localStorage.getItem("indent:readyList")||"[]");    // ç¢ºå®š -> ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
let checkedList = JSON.parse(localStorage.getItem("indent:checkedList")||"[]");// ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ï¼ˆå€‹åˆ¥è¨˜éŒ²ï¼‰

// é‡è¤‡ã‚¿ãƒƒãƒ—é˜²æ­¢ã®ãŸã‚ã®ãƒ•ãƒ©ã‚°
let lastTouchTime = 0;
function addSmartClick(el, handler){
  // allows both touch and click but avoids double-fire
  el.addEventListener("touchstart", (ev)=>{
    const now = Date.now();
    if(now - lastTouchTime < 700) return;
    lastTouchTime = now;
    handler(ev);
  }, {passive:true});
  el.addEventListener("click", (ev)=>{
    const now = Date.now();
    if(now - lastTouchTime < 700){
      // a recent touch handled it â€” skip this click
      lastTouchTime = 0;
      return;
    }
    handler(ev);
  });
}

// è¨€èªãƒ†ã‚­ã‚¹ãƒˆ
const texts = {
  ja: {
    title_wait: "ãƒã‚§ãƒƒã‚¯å¾…ã¡ãƒªã‚¹ãƒˆ",
    title_ready: "ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ",
    title_checked: "ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ãƒªã‚¹ãƒˆ",
    add_temp: "è¿½åŠ ï¼ˆä¸€æ™‚ï¼‰",
    ocr: "ğŸ“· æ’®å½±ã—ã¦OCR",
    group_create: "ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆï¼ˆé¸æŠå•†å“ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼‰",
    decide: "é¸æŠå•†å“ã‚’ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã«æ±ºå®š",
    reset_wait: "ãƒã‚§ãƒƒã‚¯å¾…ã¡ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ",
    reset_all: "å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ",
    reset_checked: "ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ",
    enter_password: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›",
    login: "ãƒ­ã‚°ã‚¤ãƒ³",
    enter_id: "ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›",
    pass_required: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…ˆã«çªç ´ã—ã¦ãã ã•ã„",
    enter_id_alert: "IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
    code7: "7æ¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
    copied: "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ",
    ocrAdded: "OCRã§è¿½åŠ ã—ã¾ã—ãŸ",
    no_hit: "è©²å½“ãªã—",
    specify_count: "å€‹æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
    beepLabel: "ãƒ”ãƒƒ",
    enter_group_name: "ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
    scan_placeholder: "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ / æ‰‹å…¥åŠ›ã§ãƒã‚§ãƒƒã‚¯ï¼ˆEnterï¼‰",
    memo_placeholder: "ãƒ¡ãƒ¢ï¼ˆ1è¡Œï¼‰",
    decide_ok: "ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã«ç§»ã—ã¾ã—ãŸ"
  },
  en: {
    title_wait: "Waiting list",
    title_ready: "Checklist",
    title_checked: "Checked items",
    add_temp: "Add (temp)",
    ocr: "ğŸ“· Capture & OCR",
    group_create: "Create group (for selected)",
    decide: "Decide selected â†’ Checklist",
    reset_wait: "Reset waiting list",
    reset_all: "Reset all data",
    reset_checked: "Reset checked list",
    enter_password: "Enter Password",
    login: "Login",
    enter_id: "Enter user ID",
    pass_required: "Please enter password first",
    enter_id_alert: "Please enter ID",
    code7: "Please enter 7 digits code",
    copied: "Copied",
    ocrAdded: "Added via OCR",
    no_hit: "No match",
    specify_count: "Specify count",
    beepLabel: "Beep",
    enter_group_name: "Please enter group name",
    scan_placeholder: "Scan or type code (Enter)",
    memo_placeholder: "Memo (1 line)",
    decide_ok: "Moved to checklist"
  }
};

// ãƒ”ãƒƒéŸ³ä½œæˆï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠé¢¨ã®çŸ­ã„éŸ³ï¼‰
let audioCtx;
function playBeep(){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "square";
    o.frequency.value = 1400; // é«˜ã‚ã®çŸ­ã„éŸ³
    g.gain.value = 0.0015; // å°ã•ã‚ï¼ˆç«¯æœ«ã«åˆã‚ã›èª¿æ•´ï¼‰
    o.connect(g);
    g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); }, 80); // 80ms ã®çŸ­ã„éŸ³
  }catch(e){
    console.warn("Audio not available", e);
  }
}

// ä¿å­˜
function saveAll(){
  localStorage.setItem("indent:waitList", JSON.stringify(waitList));
  localStorage.setItem("indent:readyList", JSON.stringify(readyList));
  localStorage.setItem("indent:checkedList", JSON.stringify(checkedList));
}

// helper: grouped summary for checkedList
function getCheckedSummary(){
  const summary = {};
  checkedList.forEach(it=>{
    if(!summary[it.code]) summary[it.code] = {qty:0, memo: it.memo || "", group: it.group || ""};
    summary[it.code].qty += Number(it.qty||1);
  });
  return summary;
}

/* =============== UI æ›´æ–° =============== */
const dom = {
  title: document.getElementById("title"),
  pagePassword: document.getElementById("page-password"),
  pageLogin: document.getElementById("page-login"),
  pageWait: document.getElementById("page-wait"),
  pageReady: document.getElementById("page-ready"),
  pageChecked: document.getElementById("page-checked"),
  waitListEl: document.getElementById("waitList"),
  readyListEl: document.getElementById("readyList"),
  checkedListEl: document.getElementById("checkedList"),
  passwordInput: document.getElementById("passwordInput"),
  passwordSubmit: document.getElementById("passwordSubmit"),
  userIdInput: document.getElementById("userIdInput"),
  loginSubmit: document.getElementById("loginSubmit"),
  ocrInput: document.getElementById("ocrInput"),
  ocrCaptureBtn: document.getElementById("ocrCaptureBtn"),
  decideBtn: document.getElementById("decideBtn"),
  groupNameInput: document.getElementById("groupNameInput"),
  groupCreateBtn: document.getElementById("groupCreateBtn"),
  scanInputReady: document.getElementById("scanInputReady"),
  scanBtnReady: document.getElementById("scanBtnReady"),
  countModal: document.getElementById("countModal"),
  countModalInput: document.getElementById("countModalInput"),
  countModalText: document.getElementById("countModalText"),
  countModalOk: document.getElementById("countModalOk"),
  countModalCancel: document.getElementById("countModalCancel")
};

let currentPage = "page-password";

function showPage(id){
  // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ»ãƒ­ã‚°ã‚¤ãƒ³è¦ä»¶
  if(id !== "page-password" && id !== "page-login"){
    if(!isPasswordOk || !isLoginOk){
      alert(texts[lang].pass_required);
      return;
    }
  }
  currentPage = id;
  // hide all
  ["page-password","page-login","page-wait","page-ready","page-checked"].forEach(pid=>{
    document.getElementById(pid).classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");

  // header title update
  if(id === "page-wait") dom.title.textContent = texts[lang].title_wait;
  if(id === "page-ready") dom.title.textContent = texts[lang].title_ready;
  if(id === "page-checked") dom.title.textContent = texts[lang].title_checked;
  if(id === "page-password") dom.title.textContent = texts[lang].enter_password;
  if(id === "page-login") dom.title.textContent = texts[lang].login;

  updateLangTexts();
  renderAll();
}

function updateLangTexts(){
  // buttons & placeholders
  document.getElementById("addProductBtn_wait").textContent = texts[lang].add_temp;
  document.getElementById("ocrCaptureBtn").textContent = texts[lang].ocr;
  document.getElementById("groupCreateBtn").textContent = texts[lang].group_create;
  document.getElementById("decideBtn").textContent = texts[lang].decide;
  document.getElementById("resetWaitBtn").textContent = texts[lang].reset_wait;
  document.getElementById("resetAllBtn").textContent = texts[lang].reset_all;
  document.getElementById("resetCheckedBtn").textContent = texts[lang].reset_checked;
  document.getElementById("productCodeInput_wait").placeholder = texts[lang].scan_placeholder;
  document.getElementById("productMemoInput_wait").placeholder = texts[lang].memo_placeholder;
  dom.scanInputReady.placeholder = texts[lang].scan_placeholder;
  dom.countModalText.textContent = texts[lang].specify_count;
}

function renderAll(){
  renderWaitList();
  renderReadyList();
  renderCheckedList();
}

function renderWaitList(){
  const el = dom.waitListEl;
  el.innerHTML = "";
  waitList.forEach((it, idx)=>{
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `
      <input type="checkbox" class="selectItem" data-i="${idx}" />
      <div class="code">${it.code}</div>
      <input class="small qtyInput" data-i="${idx}" value="${it.qty||1}" type="number" min="1" style="width:80px" />
      <input class="memoInput" data-i="${idx}" value="${it.memo||''}" placeholder="${texts[lang].memo_placeholder}" style="flex:1" />
      <div style="min-width:120px">${it.group?('['+it.group+']'):""}</div>
      <button class="copyBtn small" data-code="${it.code}">ã‚³ãƒ”ãƒ¼</button>
    `;
    el.appendChild(div);
  });
  // attach event delegation once (safe to re-attach but we avoid duplicates by checking)
  if(!renderWaitList.bound){
    el.addEventListener("click", (e)=>{
      const t = e.target;
      if(t.classList.contains("copyBtn")){
        navigator.clipboard.writeText(t.dataset.code);
        alert(texts[lang].copied);
      }
    });
    renderWaitList.bound = true;
  }

  // qty and memo changes
  el.querySelectorAll(".qtyInput").forEach(inp=>{
    inp.onchange = (ev)=>{
      const i = Number(inp.dataset.i);
      waitList[i].qty = Math.max(1, Number(inp.value)||1);
      saveAll();
    };
  });
  el.querySelectorAll(".memoInput").forEach(inp=>{
    inp.oninput = (ev)=>{
      const i = Number(inp.dataset.i);
      waitList[i].memo = inp.value;
      saveAll();
    };
  });
}

function renderReadyList(){
  const el = dom.readyListEl;
  el.innerHTML = "";
  readyList.forEach((it, idx)=>{
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `
      <div class="code">${it.code} ${it.group?('['+it.group+']'):""}</div>
      <input class="small readyQty" data-i="${idx}" value="${it.qty||1}" type="number" min="1" style="width:80px" />
      <input class="memoInput readyMemo" data-i="${idx}" value="${it.memo||''}" placeholder="${texts[lang].memo_placeholder}" style="flex:1" />
      <button class="checkBtn small" data-i="${idx}">âœ”</button>
    `;
    el.appendChild(div);
  });

  if(!renderReadyList.bound){
    el.addEventListener("click", (e)=>{
      const t = e.target;
      if(t.classList.contains("checkBtn")){
        const i = Number(t.dataset.i);
        // 1å€‹ã ã‘ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã«ç§»å‹•ï¼ˆæ®‹ã‚Šã¯readyã«æ®‹ã‚‹ï¼‰
        if(i < 0 || i >= readyList.length) return;
        const item = readyList[i];
        // move one
        checkedList.push({code:item.code, qty:1, memo:item.memo, group:item.group});
        item.qty = Number(item.qty) - 1;
        if(item.qty <= 0){
          readyList.splice(i,1);
        }
        saveAll();
        renderAll();
        playBeep(); // ãƒ”ãƒƒéŸ³
      }
    });
    renderReadyList.bound = true;
  }

  // quantity and memo change handlers
  el.querySelectorAll(".readyQty").forEach(inp=>{
    inp.onchange = ()=>{ const i = Number(inp.dataset.i); readyList[i].qty = Math.max(1, Number(inp.value)||1); saveAll(); renderReadyList(); };
  });
  el.querySelectorAll(".readyMemo").forEach(inp=>{
    inp.oninput = ()=>{ const i = Number(inp.dataset.i); readyList[i].memo = inp.value; saveAll(); };
  });
}

function renderCheckedList(){
  const el = dom.checkedListEl;
  el.innerHTML = "";
  const summary = getCheckedSummary();
  Object.keys(summary).forEach(code=>{
    const it = summary[code];
    const div = document.createElement("div");
    div.className = "list-item";
    div.textContent = `${code} Ã—${it.qty}` + (it.memo?(' ('+it.memo+')'):"") + (it.group?(' ['+it.group+']'):"");
    el.appendChild(div);
  });
}

/* =============== ã‚¤ãƒ™ãƒ³ãƒˆ: è¨€èª / èªè¨¼ / ãƒŠãƒ“ =============== */
addSmartClick(document.getElementById("langBtn"), ()=>{
  lang = (lang === "ja" ? "en" : "ja");
  updateLangTexts();
  renderAll();
});

addSmartClick(dom.passwordSubmit, ()=>{
  const val = dom.passwordInput.value.trim();
  if(val === PASSWORD){
    isPasswordOk = true;
    showPage("page-login");
  } else {
    document.getElementById("passwordError").style.display = "block";
    setTimeout(()=>document.getElementById("passwordError").style.display="none",2000);
  }
});

addSmartClick(dom.loginSubmit, ()=>{
  if(!isPasswordOk) return alert(texts[lang].pass_required);
  const id = dom.userIdInput.value.trim();
  if(!id) return alert(texts[lang].enter_id_alert);
  localStorage.setItem("indent:user", id);
  isLoginOk = true;
  showPage("page-wait");
});

// nav
addSmartClick(document.getElementById("navChecklist"), ()=> showPage("page-wait"));
addSmartClick(document.getElementById("navReady"), ()=> showPage("page-ready"));
addSmartClick(document.getElementById("navChecked"), ()=> showPage("page-checked"));

/* =============== ã‚¤ãƒ™ãƒ³ãƒˆ: ãƒã‚§ãƒƒã‚¯å¾…ã¡ (è¿½åŠ ãƒ»OCRãƒ»ã‚°ãƒ«ãƒ¼ãƒ—ãƒ»æ±ºå®š) =============== */

// add temp (wait) from hand input
addSmartClick(document.getElementById("addProductBtn_wait"), ()=>{
  if(!isLoginOk) return alert(texts[lang].pass_required);
  const code = document.getElementById("productCodeInput_wait").value.trim();
  const qty = Math.max(1, Number(document.getElementById("productQtyInput_wait").value) || 1);
  const memo = document.getElementById("productMemoInput_wait").value.trim();
  if(!/^\d{7}$/.test(code)) return alert(texts[lang].code7);
  waitList.push({code, qty, memo, group: ""});
  saveAll(); renderWaitList();
  document.getElementById("productCodeInput_wait").value = "";
  document.getElementById("productMemoInput_wait").value = "";
});

// OCR capture -> crop -> recognize
let tmpImage = null;

// open file selector
addSmartClick(dom.ocrCaptureBtn, ()=> dom.ocrInput.click());

dom.ocrInput.addEventListener("change", async (ev)=>{
  if(!isLoginOk) return alert(texts[lang].pass_required);
  const file = ev.target.files[0];
  if(!file) return;
  // load image into canvas and allow user to crop
  const img = new Image();
  const url = URL.createObjectURL(file);
  img.src = url;
  await new Promise(r=>img.onload = r);
  // create a simple inline cropping UI using canvas
  await cropAndRecognize(img);
  dom.ocrInput.value = ""; 
});

async function cropAndRecognize(img){
  // Create modal-like canvas for cropping
  const w = Math.min(img.width, 1200);
  const h = Math.min(img.height, 1200 * (img.height/img.width));
  const canvas = document.createElement("canvas");
  canvas.width = img.width;
  canvas.height = img.height;
  canvas.style.maxWidth = "92%";
  canvas.style.border = "2px solid #111";
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0);
  // show overlay for cropping
  const modal = document.createElement("div");
  modal.className = "modal";
  modal.innerHTML = `<div class="card" style="max-width:95%;padding:8px">
    <div style="margin-bottom:8px">ç¯„å›²ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é¸æŠå¾Œã€ŒãƒˆãƒªãƒŸãƒ³ã‚°ã—ã¦OCRã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
    <div id="canvasWrap" style="text-align:center"></div>
    <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end">
      <button id="cancelCrop">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="doCrop">ãƒˆãƒªãƒŸãƒ³ã‚°ã—ã¦OCR</button>
    </div>
  </div>`;
  document.body.appendChild(modal);
  document.getElementById("canvasWrap").appendChild(canvas);
  // simple drag-to-select
  let sx=0, sy=0, ex=0, ey=0, dragging=false;
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0);
    if(dragging || (sx!==ex && sy!==ey)){
      const x = Math.min(sx,ex), y = Math.min(sy,ey), ww=Math.abs(ex-sx), hh=Math.abs(ey-sy);
      ctx.fillStyle = 'rgba(0,0,0,0.3)';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      // clear selection area
      ctx.clearRect(x,y,ww,hh);
      ctx.strokeStyle = '#ff0';
      ctx.lineWidth=3;
      ctx.strokeRect(x,y,ww,hh);
    }
  }
  canvas.addEventListener("pointerdown", (e)=>{
    dragging=true;
    const rect = canvas.getBoundingClientRect();
    sx = (e.clientX - rect.left) * (canvas.width/rect.width);
    sy = (e.clientY - rect.top) * (canvas.height/rect.height);
    ex = sx; ey = sy;
    draw();
  });
  window.addEventListener("pointermove", moveHandler);
  function moveHandler(e){
    if(!dragging) return;
    const rect = canvas.getBoundingClientRect();
    ex = (e.clientX - rect.left) * (canvas.width/rect.width);
    ey = (e.clientY - rect.top) * (canvas.height/rect.height);
    draw();
  }
  window.addEventListener("pointerup", upHandler);
  function upHandler(e){
    if(!dragging) return;
    dragging=false;
    draw();
  }

  // cancel
  document.getElementById("cancelCrop").addEventListener("click", ()=>{
    window.removeEventListener("pointermove", moveHandler);
    window.removeEventListener("pointerup", upHandler);
    modal.remove();
    URL.revokeObjectURL(img.src);
  });

  // do crop and OCR
  document.getElementById("doCrop").addEventListener("click", async ()=>{
    window.removeEventListener("pointermove", moveHandler);
    window.removeEventListener("pointerup", upHandler);
    // if selection invalid, take full image
    const x = Math.max(0, Math.min(sx,ex)|0);
    const y = Math.max(0, Math.min(sy,ey)|0);
    const wSel = Math.abs(ex-sx)|0;
    const hSel = Math.abs(ey-sy)|0;
    let useCanvas = document.createElement("canvas");
    if(wSel>10 && hSel>10){
      useCanvas.width = wSel; useCanvas.height = hSel;
      useCanvas.getContext("2d").drawImage(img, x, y, wSel, hSel, 0, 0, wSel, hSel);
    } else {
      // use full
      useCanvas.width = img.width; useCanvas.height = img.height;
      useCanvas.getContext("2d").drawImage(img, 0, 0);
    }
    // convert to blob
    useCanvas.toBlob(async (blob)=>{
      // OCR with Tesseract (eng+jpn)
      try{
        // show a short loading note
        alert("OCRä¸­...ï¼ˆæ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰");
        const worker = Tesseract.createWorker({logger:m=>console.log(m)});
        await worker.load();
        await worker.loadLanguage('eng+jpn');
        await worker.initialize('eng+jpn');
        const { data: { text } } = await worker.recognize(blob);
        await worker.terminate();
        // find 7-digit codes
        const codes = (text && text.match(/\b\d{7}\b/g)) || [];
        if(codes.length === 0){
          alert(texts[lang].no_hit);
        } else {
          codes.forEach(c=>{
            waitList.push({code:c, qty:1, memo:"", group:""});
          });
          saveAll(); renderWaitList();
          alert(texts[lang].ocrAdded);
        }
      }catch(err){
        console.error(err);
        alert("OCRã‚¨ãƒ©ãƒ¼");
      }
    }, "image/png");
    modal.remove();
    URL.revokeObjectURL(img.src);
  });
}

// group creation for selected wait items
addSmartClick(document.getElementById("groupCreateBtn"), ()=>{
  const g = document.getElementById("groupNameInput").value.trim();
  if(!g) return alert(texts[lang].enter_group_name);
  const checked = Array.from(document.querySelectorAll(".selectItem:checked")).map(c=>Number(c.dataset.i));
  if(checked.length===0) return alert("No items selected");
  checked.forEach(i=>{
    if(waitList[i]) waitList[i].group = g;
  });
  saveAll(); renderWaitList();
  document.getElementById("groupNameInput").value = "";
});

// decide: move selected wait items to readyList (checklist)
addSmartClick(document.getElementById("decideBtn"), ()=>{
  const checkedBoxes = Array.from(document.querySelectorAll(".selectItem:checked"));
  if(checkedBoxes.length === 0) return alert("No items selected");
  // sort indices descending so we can remove safely
  const indices = checkedBoxes.map(cb=>Number(cb.dataset.i)).sort((a,b)=>b-a);
  indices.forEach(i=>{
    const it = {...waitList[i]}; // copy with memo/group
    readyList.push(it);
    waitList.splice(i,1);
  });
  saveAll();
  renderAll();
  alert(texts[lang].decide_ok);
});

// reset wait
addSmartClick(document.getElementById("resetWaitBtn"), ()=>{
  if(!confirm("Reset waiting list?")) return;
  waitList = []; saveAll(); renderAll();
});

// reset all
addSmartClick(document.getElementById("resetAllBtn"), ()=>{
  if(!confirm("Reset ALL data?")) return;
  waitList = []; readyList = []; checkedList = []; saveAll(); renderAll();
});

/* =============== ã‚¤ãƒ™ãƒ³ãƒˆ: Ready (æ¤œç´¢/ãƒã‚§ãƒƒã‚¯ via scanInputReady) =============== */

// search and check by code input (Enter or button)
addSmartClick(dom.scanBtnReady, ()=> handleScanCode(dom.scanInputReady.value.trim()));
document.getElementById("scanInputReady").addEventListener("keypress", (e)=>{
  if(e.key === "Enter"){ handleScanCode(e.target.value.trim()); e.target.value=""; }
});

function handleScanCode(code){
  if(!isLoginOk) return alert(texts[lang].pass_required);
  if(!code) return;
  // find matching readyList items (same code)
  const hits = readyList.map((it, idx)=>({it, idx})).filter(o=>o.it.code === code);
  if(hits.length === 0){
    return alert(texts[lang].no_hit);
  }
  // if there is exactly one item and qty===1 -> immediate
  // if single item with qty>1 OR multiple items -> ask quantity to move
  let totalAvailable = hits.reduce((s,h)=>s + Number(h.it.qty||1), 0);
  if(totalAvailable === 1){
    // remove that one
    const idx = hits[0].idx;
    const item = readyList[idx];
    checkedList.push({code:item.code, qty:1, memo:item.memo, group:item.group});
    readyList.splice(idx,1);
    saveAll(); renderAll(); playBeep();
    return;
  }
  // else we need to ask how many to move
  showCountModal(totalAvailable, (count)=>{
    // move 'count' quantity from the hits in order
    let remaining = count;
    // iterate hits by index ascending
    const ordered = hits.sort((a,b)=>a.idx - b.idx);
    ordered.forEach(h=>{
      if(remaining <= 0) return;
      const available = Number(h.it.qty||1);
      const take = Math.min(available, remaining);
      // add taken to checkedList
      checkedList.push({code:h.it.code, qty: take, memo:h.it.memo, group:h.it.group});
      // reduce source
      h.it.qty = available - take;
      remaining -= take;
    });
    // remove any items with qty<=0 in readyList
    readyList = readyList.filter(it=>Number(it.qty) > 0);
    saveAll(); renderAll(); playBeep();
  });
}

/* =============== Count modal helpers =============== */
function showCountModal(max, onOk){
  dom.countModal.classList.remove("hidden");
  dom.countModalInput.value = 1;
  dom.countModalText.textContent = texts[lang].specify_count + ` (1ã€œ${max})`;
  dom.countModalInput.min = 1;
  dom.countModalInput.max = max;
  dom.countModalOk.onclick = ()=>{
    let v = Math.min(Math.max(Number(dom.countModalInput.value)||1, 1), max);
    dom.countModal.classList.add("hidden");
    onOk(v);
  };
  dom.countModalCancel.onclick = ()=>{
    dom.countModal.classList.add("hidden");
  };
}

/* =============== Checked reset =============== */
addSmartClick(document.getElementById("resetCheckedBtn"), ()=>{
  if(!confirm("Reset checked list?")) return;
  checkedList = []; saveAll(); renderAll();
});

/* =============== Initial render & read saved user =============== */
(function init(){
  // restore login state if user exists (but still require password & id)
  if(localStorage.getItem("indent:user")){
    // we don't auto-login for security â€” keep isLoginOk false until login flow
  }
  updateLangTexts();
  renderAll();
  // show password page first
  showPage("page-password");
})();

</script>
</body>
</html>
