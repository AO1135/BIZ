<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Indent — チェックリスト</title>
<style>
body { font-family: 'Noto Sans JP', sans-serif; margin: 0; background: #fff; color: #000; }
header { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #ccc; }
h1 { font-size: 18px; margin: 0; }
main { padding: 12px; }
button, input, select, textarea { font-size: 16px; padding: 8px; border: 1px solid #000; border-radius: 6px; width: 100%; box-sizing: border-box; }
button { background: #000; color: #fff; cursor: pointer; }
nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; background: #000; }
nav button { flex: 1; border: none; border-right: 1px solid #fff; background: #000; color: #fff; padding: 10px; }
nav button:last-child { border-right: none; }
.hidden { display: none; }
.list-item { border: 1px solid #000; padding: 8px; margin-bottom: 6px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 6px; }
.small-input { width: 60px; }
textarea { width: 100%; margin-top: 4px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body>
<header>
  <h1 id="title">パスワード入力</h1>
  <button id="langBtn">日本語 / English</button>
</header>

<main>
  <section id="page-password">
    <input id="passwordInput" type="password" placeholder="パスワードを入力" />
    <button id="passwordSubmit">ログイン</button>
    <p id="passwordError" style="color:red;display:none">パスワードが違います</p>
  </section>

  <section id="page-login" class="hidden">
    <input id="userIdInput" placeholder="ユーザーIDを入力" />
    <button id="loginSubmit">ログイン</button>
  </section>

  <section id="page-precheck" class="hidden">
    <h2 id="precheckTitle">チェック待ちリスト</h2>
    <div style="display:flex;gap:8px;margin-bottom:8px; flex-wrap: wrap;">
      <input id="productCodeInput" placeholder="7桁のコード" />
      <input id="productQtyInput" type="number" min="1" value="1" />
      <input id="productMemoInput" placeholder="メモ" />
      <button id="addProductBtn">追加</button>
      <button id="ocrBtn">OCR追加</button>
    </div>
    <div id="precheckList"></div>
    <button id="precheckConfirm">チェックリストへ確定</button>
    <button id="precheckReset">リセット</button>
  </section>

  <section id="page-checklist" class="hidden">
    <h2 id="checklistTitle">チェックリスト</h2>
    <div id="checklist"></div>
    <button id="checklistReset">リセット</button>
  </section>

  <section id="page-checked" class="hidden">
    <h2 id="checkedTitle">チェック済みリスト</h2>
    <div id="checkedList"></div>
  </section>
</main>

<nav>
  <button id="navPrecheck">チェック前リスト</button>
  <button id="navChecklist">チェックリスト</button>
  <button id="navChecked">チェック済み一覧</button>
</nav>

<script>
const PASSWORD='0509';
let lang='ja';
let precheckList = JSON.parse(localStorage.getItem('indent:precheck')||'[]');
let checklist = JSON.parse(localStorage.getItem('indent:checklist')||'[]');
let checkedList = JSON.parse(localStorage.getItem('indent:checked')||'[]');

function saveData(){
  localStorage.setItem('indent:precheck',JSON.stringify(precheckList));
  localStorage.setItem('indent:checklist',JSON.stringify(checklist));
  localStorage.setItem('indent:checked',JSON.stringify(checkedList));
}

function showPage(id){
  ['page-precheck','page-checklist','page-checked'].forEach(p=>document.getElementById(p).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.getElementById('title').textContent={
    'page-precheck':'チェック待ちリスト',
    'page-checklist':'チェックリスト',
    'page-checked':'チェック済みリスト'
  }[id];
}

// Precheck
function renderPrecheck(){
  const el=document.getElementById('precheckList'); el.innerHTML='';
  precheckList.forEach((item,i)=>{
    const div=document.createElement('div');
    div.className='list-item';
    div.innerHTML=`${item.code} <input type='number' class='small-input qty' data-i='${i}' value='${item.qty}' min='1'> <input type='text' class='small-input memo' data-i='${i}' value='${item.memo||''}' placeholder='メモ'> <button data-i='${i}' class='removeBtn'>削除</button>`;
    el.appendChild(div);
  });

  // ボタン・入力イベント
  document.querySelectorAll('.removeBtn').forEach(btn=>btn.onclick=e=>{
    precheckList.splice(e.target.dataset.i,1); saveData(); renderPrecheck();
  });
  document.querySelectorAll('.qty').forEach(input=>input.onchange=e=>{
    precheckList[e.target.dataset.i].qty=Number(e.target.value); saveData();
  });
  document.querySelectorAll('.memo').forEach(input=>input.onchange=e=>{
    precheckList[e.target.dataset.i].memo=e.target.value; saveData();
  });
}

// Checklist
function renderChecklist(){
  const el=document.getElementById('checklist'); el.innerHTML='';
  checklist.forEach((item,i)=>{
    const div=document.createElement('div'); div.className='list-item';
    div.innerHTML=`${item.code} ×${item.qty} <span class='memo'>${item.memo||''}</span> <button data-i='${i}' class='checkBtn'>✔</button>`;
    el.appendChild(div);
  });

  document.querySelectorAll('.checkBtn').forEach(btn=>btn.onclick=e=>{
    const i=e.target.dataset.i;
    if(checklist[i].qty>1){ checklist[i].qty--; checkedList.push({code:checklist[i].code,qty:1,memo:checklist[i].memo}); }
    else { checkedList.push(checklist[i]); checklist.splice(i,1); }
    saveData(); renderChecklist(); renderChecked(); playSound('success');
  });
}

// Checked
function renderChecked(){
  const el=document.getElementById('checkedList'); el.innerHTML='';
  const grouped={};
  checkedList.forEach(it=>{
    if(grouped[it.code]) grouped[it.code].qty+=it.qty;
    else grouped[it.code]={...it};
  });

  Object.values(grouped).forEach((it,i)=>{
    const div=document.createElement('div'); div.className='list-item';
    div.innerHTML=`
      ${it.code} ×${it.qty} <button data-i='${i}' class='returnBtn'>↩</button>
      <textarea class='memo-checked' data-i='${i}' placeholder='メモ'>${it.memo||''}</textarea>
    `;
    el.appendChild(div);
  });

  document.querySelectorAll('.returnBtn').forEach(btn=>{
    btn.onclick=e=>{
      const i=e.target.dataset.i;
      const codeObj = Object.values(grouped)[i];
      checklist.push({...codeObj});
      // チェック済みから該当コードを1つだけ減らす
      let count = codeObj.qty;
      checkedList = checkedList.map(it=>{
        if(it.code===codeObj.code && count>0){
          const newIt={...it};
          newIt.qty--;
          count--;
          return newIt.qty>0?newIt:null;
        }
        return it;
      }).filter(Boolean);
      saveData(); renderChecklist(); renderChecked();
    };
  });

  document.querySelectorAll('.memo-checked').forEach(input=>{
    input.onchange=e=>{
      const i=e.target.dataset.i;
      const codeObj = Object.values(grouped)[i];
      Object.values(grouped)[i].memo = e.target.value;
      // 更新
      checkedList = Object.values(grouped);
      saveData();
    };
  });
}

function playSound(type){
  const audio=new Audio();
  if(type==='success') audio.src='data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YQAAAAA=';
  audio.play();
}

// Add product
document.getElementById('addProductBtn').onclick=()=>{
  const code=document.getElementById('productCodeInput').value.trim();
  const qty=Number(document.getElementById('productQtyInput').value)||1;
  const memo=document.getElementById('productMemoInput').value.trim();
  if(!/^\d{7}$/.test(code)) return alert('7桁のコードを入力してください');
  precheckList.push({code,qty,memo}); saveData(); renderPrecheck();
  document.getElementById('productCodeInput').value='';
