<script>
document.addEventListener("DOMContentLoaded", () => {
  const PASSWORD = "0509";
  const passwordInput = document.getElementById("password");
  const passwordSubmit = document.getElementById("passwordSubmit");
  const mainApp = document.getElementById("mainApp");
  const loginPage = document.getElementById("loginPage");

  const ocrInput = document.getElementById("ocrInput");
  const ocrButton = document.getElementById("ocrButton");
  const waitingList = document.getElementById("waitingList");

  // âœ… ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ¼
  const STORAGE_KEY = "waitingListData";

  // ---------------------------------------------------------
  // ðŸŸ© ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼
  // ---------------------------------------------------------
  passwordSubmit.addEventListener("click", () => {
    if (passwordInput.value === PASSWORD) {
      loginPage.style.display = "none";
      mainApp.style.display = "block";
      restoreList();
    } else {
      alert("Wrong password!");
    }
  });

  // ---------------------------------------------------------
  // ðŸŸ© OCRæ©Ÿèƒ½ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ è‡ªå‹•è¿½åŠ ï¼‰
  // ---------------------------------------------------------
  ocrButton.addEventListener("click", async () => {
    const file = ocrInput.files[0];
    if (!file) {
      alert("Please select an image first!");
      return;
    }

    const reader = new FileReader();
    reader.onload = async function() {
      const { createWorker } = Tesseract;
      const worker = await createWorker("eng+jpn");
      const { data: { text } } = await worker.recognize(reader.result);
      await worker.terminate();

      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);
      lines.forEach(num => addToWaitingList(num));
    };
    reader.readAsDataURL(file);
  });

  // ---------------------------------------------------------
  // ðŸŸ© ãƒã‚§ãƒƒã‚¯å¾…ã¡ãƒªã‚¹ãƒˆã«è¿½åŠ 
  // ---------------------------------------------------------
  function addToWaitingList(number, memoText = "") {
    const li = document.createElement("li");
    li.className = "flex items-center justify-between border-b py-1";

    const left = document.createElement("span");
    left.textContent = number;

    const memo = document.createElement("input");
    memo.type = "text";
    memo.placeholder = "memo";
    memo.value = memoText;
    memo.className = "text-xs border rounded px-1 ml-2 w-20";

    const checkBtn = document.createElement("button");
    checkBtn.textContent = "âœ“";
    checkBtn.className = "bg-green-500 text-white px-2 py-1 rounded text-xs ml-2";

    // âœ… ãƒ¡ãƒ¢æ¬„ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ä¿å­˜
    memo.addEventListener("input", saveList);

    // âœ… ãƒã‚§ãƒƒã‚¯ãƒœã‚¿ãƒ³ï¼ˆå¾Œã§å‡¦ç†è¿½åŠ å¯ï¼‰
    checkBtn.addEventListener("click", () => {
      alert(`Checked: ${number}`);
      li.remove();
      saveList();
    });

    li.append(left, memo, checkBtn);
    waitingList.appendChild(li);

    saveList();
  }

  // ---------------------------------------------------------
  // ðŸŸ© ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜
  // ---------------------------------------------------------
  function saveList() {
    const data = [];
    waitingList.querySelectorAll("li").forEach(li => {
      const num = li.querySelector("span").textContent;
      const memo = li.querySelector("input").value;
      data.push({ num, memo });
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  // ---------------------------------------------------------
  // ðŸŸ© å¾©å…ƒ
  // ---------------------------------------------------------
  function restoreList() {
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    saved.forEach(item => addToWaitingList(item.num, item.memo));
  }
});
</script>
