<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Indent — チェックリスト</title>
<style>
  :root{--bg:#fff;--fg:#000}
  body{font-family:"Noto Sans JP",system-ui,Arial;margin:0;background:var(--bg);color:var(--fg);-webkit-tap-highlight-color:transparent}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #ddd}
  h1{font-size:18px;margin:0}
  main{padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,button,select,textarea{font-size:16px;padding:8px;border:1px solid #111;border-radius:8px;box-sizing:border-box}
  button{background:#000;color:#fff;cursor:pointer}
  .hidden{display:none}
  nav{position:fixed;left:0;right:0;bottom:0;display:flex;background:#000}
  nav button{flex:1;padding:12px;border:none;color:#fff;background:#000}
  .list-item{border:1px solid #111;padding:8px;margin-bottom:8px;border-radius:8px;display:flex;gap:8px;align-items:center;flex-wrap:nowrap}
  .code{font-weight:600;min-width:110px}
  .memoSmall{font-size:14px;width:180px;padding:6px}
  .small{font-size:13px;padding:6px}
  .muted{color:#666;font-size:13px}
</style>

<!-- Tesseract.js（CDN） -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
<header>
  <h1 id="title">パスワード入力</h1>
  <button id="langBtn" class="small">日本語 / English</button>
</header>

<main>
  <!-- Password -->
  <section id="page-password">
    <div class="row">
      <input id="passwordInput" type="password" placeholder="パスワードを入力" />
      <button id="passwordSubmit">ログイン</button>
    </div>
    <p id="passwordError" style="color:red;display:none">パスワードが違います</p>
  </section>

  <!-- Login -->
  <section id="page-login" class="hidden">
    <div class="row">
      <input id="userIdInput" placeholder="ユーザーIDを入力" />
      <button id="loginSubmit">ログイン</button>
    </div>
  </section>

  <!-- Wait list -->
  <section id="page-wait" class="hidden">
    <h2 id="waitTitle">チェック待ちリスト</h2>

    <div class="row" style="margin-bottom:8px">
      <input id="productCodeInput_wait" placeholder="7桁のコード (手入力/バーコード)" />
      <input id="productQtyInput_wait" type="number" min="1" value="1" style="width:90px" />
      <input id="productMemoInput_wait" placeholder="メモ（1行）" style="width:180px" />
      <button id="addProductBtn_wait">追加（一時）</button>
    </div>

    <div class="row" style="margin-bottom:8px">
      <button id="ocrCaptureBtn">📷 撮影してOCR（画像を選ぶと自動で追加）</button>
      <input id="ocrInput" type="file" accept="image/*" capture="environment" class="hidden" />
      <input id="groupNameInput" placeholder="グループ名" style="width:160px"/>
      <button id="groupCreateBtn">選択をグループ化</button>
    </div>

    <p class="muted">※ OCRで画像を選ぶと検出した全ての7桁コードを即座にチェック待ちリストに追加します（重複も追加）。</p>

    <div id="waitList"></div>

    <div class="row" style="margin-top:8px">
      <button id="decideBtn">選択商品をチェックリストに決定</button>
      <button id="resetWaitBtn">チェック待ちリストをリセット</button>
      <button id="resetAllBtn">全データをリセット</button>
    </div>
  </section>

  <!-- Ready list -->
  <section id="page-ready" class="hidden">
    <h2 id="readyTitle">チェックリスト</h2>
    <div class="row" style="margin-bottom:8px">
      <input id="scanInputReady" placeholder="バーコード / 手入力でチェック（Enter）" style="flex:1" />
      <button id="scanBtnReady">チェック実行</button>
      <button id="toCheckedPage">チェック済みを表示</button>
    </div>
    <div id="readyList"></div>
  </section>

  <!-- Checked list -->
  <section id="page-checked" class="hidden">
    <h2 id="checkedTitle">チェック済みリスト</h2>
    <div id="checkedList"></div>
    <div style="margin-top:8px">
      <button id="resetCheckedBtn">チェック済みリストをリセット</button>
    </div>
  </section>
</main>

<nav>
  <button id="navChecklist">📋 チェック待ち</button>
  <button id="navReady">📝 チェックリスト</button>
  <button id="navChecked">✅ チェック済み</button>
</nav>

<script>
/* ================== 設定・データ ================== */
const PASSWORD = "0509";
let lang = "ja";
let isPasswordOk = false;
let isLoginOk = false;

let waitList = JSON.parse(localStorage.getItem("indent:waitList")||"[]");
let readyList = JSON.parse(localStorage.getItem("indent:readyList")||"[]");
let checkedList = JSON.parse(localStorage.getItem("indent:checkedList")||"[]");

function saveAll(){
  localStorage.setItem("indent:waitList", JSON.stringify(waitList));
  localStorage.setItem("indent:readyList", JSON.stringify(readyList));
  localStorage.setItem("indent:checkedList", JSON.stringify(checkedList));
}

/* ================== 文言 ================== */
const texts = {
  ja: {
    waitTitle: "チェック待ちリスト",
    readyTitle: "チェックリスト",
    checkedTitle: "チェック済みリスト",
    add_temp: "追加（一時）",
    ocr: "撮影してOCR（画像を選ぶと自動で追加）",
    group_create: "選択をグループ化",
    decide: "決定（チェックリストへ）",
    reset_wait: "チェック待ちリストをリセット",
    reset_all: "全データをリセット",
    reset_checked: "チェック済みリストをリセット",
    enter_password: "パスワードを入力",
    login: "ログイン",
    pass_required: "パスワードを先に突破してください",
    enter_id_alert: "IDを入力してください",
    code7: "7桁のコードを入力してください",
    copied: "コピーしました",
    ocrAdded: "OCRで追加しました",
    ocrError: "OCRに失敗しました",
    no_hit: "該当なし",
    decide_ok: "チェックリストに移しました",
    memo_placeholder: "メモ（1行）",
    scan_placeholder: "バーコード / 手入力でチェック（Enter）"
  },
  en: {
    waitTitle: "Waiting list",
    readyTitle: "Checklist",
    checkedTitle: "Checked items",
    add_temp: "Add (temp)",
    ocr: "Capture & OCR (choose image to auto-add)",
    group_create: "Group selected",
    decide: "Decide (to checklist)",
    reset_wait: "Reset waiting list",
    reset_all: "Reset all data",
    reset_checked: "Reset checked list",
    enter_password: "Enter Password",
    login: "Login",
    pass_required: "Please enter password first",
    enter_id_alert: "Please enter ID",
    code7: "Please enter 7 digits code",
    copied: "Copied",
    ocrAdded: "Added via OCR",
    ocrError: "OCR failed",
    no_hit: "No match",
    decide_ok: "Moved to checklist",
    memo_placeholder: "Memo (1 line)",
    scan_placeholder: "Scan or type code (Enter)"
  }
};

/* ================== ビープ音（WebAudio） ================== */
/* ユーザーは MP3を希望でしたが、ここでは外部ファイル不要で確実動作する WebAudio を使います。
   音量は「やや小さめ（控えめ）」に設定してあります。 */
let audioCtx;
function playSuccessBeep(){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "square";
    o.frequency.value = 1500;
    g.gain.value = 0.0009; // やや小さめ（調整可能）
    o.connect(g);
    g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=> o.stop(), 80);
  }catch(e){ console.warn("Audio err", e); }
}
function playErrorBeep(){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    // two short beeps
    const o1 = audioCtx.createOscillator();
    const g1 = audioCtx.createGain();
    o1.type = "square"; o1.frequency.value = 800; g1.gain.value = 0.0009;
    o1.connect(g1); g1.connect(audioCtx.destination); o1.start();
    setTimeout(()=> o1.stop(), 120);
    setTimeout(()=>{
      const o2 = audioCtx.createOscillator();
      const g2 = audioCtx.createGain();
      o2.type="square"; o2.frequency.value=900; g2.gain.value=0.0009;
      o2.connect(g2); g2.connect(audioCtx.destination); o2.start();
      setTimeout(()=> o2.stop(), 120);
    }, 160);
  }catch(e){ console.warn("Audio err", e); }
}

/* ================== DOM refs ================== */
const dom = {
  title: document.getElementById("title"),
  pagePassword: document.getElementById("page-password"),
  pageLogin: document.getElementById("page-login"),
  pageWait: document.getElementById("page-wait"),
  pageReady: document.getElementById("page-ready"),
  pageChecked: document.getElementById("page-checked"),
  waitListEl: document.getElementById("waitList"),
  readyListEl: document.getElementById("readyList"),
  checkedListEl: document.getElementById("checkedList"),
  passwordInput: document.getElementById("passwordInput"),
  passwordSubmit: document.getElementById("passwordSubmit"),
  userIdInput: document.getElementById("userIdInput"),
  loginSubmit: document.getElementById("loginSubmit"),
  ocrInput: document.getElementById("ocrInput"),
  ocrCaptureBtn: document.getElementById("ocrCaptureBtn"),
  productCodeInput_wait: document.getElementById("productCodeInput_wait"),
  productQtyInput_wait: document.getElementById("productQtyInput_wait"),
  productMemoInput_wait: document.getElementById("productMemoInput_wait"),
  addProductBtn_wait: document.getElementById("addProductBtn_wait"),
  groupNameInput: document.getElementById("groupNameInput"),
  groupCreateBtn: document.getElementById("groupCreateBtn"),
  decideBtn: document.getElementById("decideBtn"),
  scanInputReady: document.getElementById("scanInputReady"),
  scanBtnReady: document.getElementById("scanBtnReady"),
  toCheckedPage: document.getElementById("toCheckedPage")
};

/* ================== UI 更新 / レンダリング ================== */
function updateLangUI(){
  document.getElementById("waitTitle").textContent = texts[lang].waitTitle;
  document.getElementById("readyTitle").textContent = texts[lang].readyTitle;
  document.getElementById("checkedTitle").textContent = texts[lang].checkedTitle;
  document.getElementById("addProductBtn_wait").textContent = texts[lang].add_temp;
  document.getElementById("ocrCaptureBtn").textContent = texts[lang].ocr;
  document.getElementById("groupCreateBtn").textContent = texts[lang].group_create;
  document.getElementById("decideBtn").textContent = texts[lang].decide;
  document.getElementById("resetWaitBtn").textContent = texts[lang].reset_wait;
  document.getElementById("resetAllBtn").textContent = texts[lang].reset_all;
  document.getElementById("resetCheckedBtn").textContent = texts[lang].reset_checked;
  dom.productCodeInput_wait.placeholder = texts[lang].scan_placeholder;
  dom.productMemoInput_wait.placeholder = texts[lang].memo_placeholder;
  dom.scanInputReady.placeholder = texts[lang].scan_placeholder;
}

function showPage(id){
  if(id !== "page-password" && id !== "page-login"){
    if(!isPasswordOk || !isLoginOk){
      alert(texts[lang].pass_required);
      return;
    }
  }
  ["page-password","page-login","page-wait","page-ready","page-checked"].forEach(pid=>document.getElementById(pid).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  if(id === "page-wait") dom.title.textContent = texts[lang].waitTitle;
  if(id === "page-ready") dom.title.textContent = texts[lang].readyTitle;
  if(id === "page-checked") dom.title.textContent = texts[lang].checkedTitle;
  if(id === "page-password") dom.title.textContent = texts[lang].enter_password;
  if(id === "page-login") dom.title.textContent = texts[lang].login;
  updateLangUI(); renderAll();
}

function renderWaitList(){
  const el = dom.waitListEl; el.innerHTML = "";
  waitList.forEach((it,i)=>{
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `
      <input type="checkbox" class="selectItem" data-i="${i}" />
      <div class="code">${it.code}</div>
      <input class="memoSmall" data-i="${i}" value="${it.memo||''}" placeholder="${texts[lang].memo_placeholder}" />
      <input class="small qtyWait" data-i="${i}" value="${it.qty||1}" type="number" min="1" style="width:80px" />
      <div style="min-width:120px">${it.group?('['+it.group+']'):""}</div>
      <button class="copyBtn small" data-code="${it.code}">コピー</button>
    `;
    el.appendChild(div);
  });
  // handlers
  el.querySelectorAll(".copyBtn").forEach(b=> b.onclick = (e)=>{ navigator.clipboard.writeText(e.target.dataset.code); alert(texts[lang].copied); });
  el.querySelectorAll(".qtyWait").forEach(inp=> inp.onchange = ()=>{ const idx = Number(inp.dataset.i); waitList[idx].qty = Math.max(1, Number(inp.value)||1); saveAll(); });
  el.querySelectorAll(".memoSmall").forEach(inp=> inp.oninput = ()=>{ const idx = Number(inp.dataset.i); waitList[idx].memo = inp.value; saveAll(); });
}

function renderReadyList(){
  const el = dom.readyListEl; el.innerHTML = "";
  readyList.forEach((it,i)=>{
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `
      <div class="code">${it.code} ${it.group?('['+it.group+']'):""}</div>
      <input class="small readyQty" data-i="${i}" value="${it.qty||1}" type="number" min="1" style="width:80px" />
      <input class="memoSmall readyMemo" data-i="${i}" value="${it.memo||''}" placeholder="${texts[lang].memo_placeholder}" />
      <button class="checkBtn small" data-i="${i}">✔</button>
    `;
    el.appendChild(div);
  });
  // attach handlers
  el.querySelectorAll(".checkBtn").forEach(b=>{
    b.onclick = (e)=>{
      const i = Number(e.target.dataset.i);
      if(i<0 || i>=readyList.length) return;
      const item = readyList[i];
      // move one unit
      checkedList.push({code:item.code, qty:1, memo:item.memo, group:item.group});
      item.qty = Number(item.qty) - 1;
      if(item.qty <= 0) readyList.splice(i,1);
      saveAll(); renderAll(); playSuccessBeep();
    };
  });
  el.querySelectorAll(".readyQty").forEach(inp=> inp.onchange = ()=>{ const i = Number(inp.dataset.i); readyList[i].qty = Math.max(1, Number(inp.value)||1); saveAll(); renderReadyList(); });
  el.querySelectorAll(".readyMemo").forEach(inp=> inp.oninput = ()=>{ const i = Number(inp.dataset.i); readyList[i].memo = inp.value; saveAll(); });
}

function renderCheckedList(){
  const el = dom.checkedListEl; el.innerHTML = "";
  const summary = {};
  checkedList.forEach(it=>{
    if(!summary[it.code]) summary[it.code] = {qty:0, memo: it.memo||"", group: it.group||""};
    summary[it.code].qty += Number(it.qty||1);
  });
  Object.keys(summary).forEach(code=>{
    const it = summary[code];
    const div = document.createElement("div");
    div.className = "list-item";
    div.textContent = `${code} ×${it.qty}` + (it.memo?(' ('+it.memo+')'):"") + (it.group?(' ['+it.group+']'):"");
    el.appendChild(div);
  });
}

function renderAll(){ renderWaitList(); renderReadyList(); renderCheckedList(); }

/* ================== 言語 / 認証 / ナビ ================== */
document.getElementById("langBtn").addEventListener("click", ()=>{ lang = (lang==="ja"?"en":"ja"); updateLangUI(); renderAll(); });

document.getElementById("passwordSubmit").addEventListener("click", ()=>{
  const v = dom.passwordInput.value.trim();
  if(v === PASSWORD){ isPasswordOk = true; showPage("page-login"); }
  else{ document.getElementById("passwordError").style.display = "block"; setTimeout(()=>document.getElementById("passwordError").style.display="none",2000); }
});

document.getElementById("loginSubmit").addEventListener("click", ()=>{
  if(!isPasswordOk) return alert(texts[lang].pass_required);
  const id = dom.userIdInput.value.trim();
  if(!id) return alert(texts[lang].enter_id_alert);
  localStorage.setItem("indent:user", id);
  isLoginOk = true;
  showPage("page-wait");
});

document.getElementById("navChecklist").addEventListener("click", ()=> showPage("page-wait"));
document.getElementById("navReady").addEventListener("click", ()=> showPage("page-ready"));
document.getElementById("navChecked").addEventListener("click", ()=> showPage("page-checked"));

/* ================== チェック待ち: 手入力追加 / グループ / 決定 / リセット ================== */
document.getElementById("addProductBtn_wait").addEventListener("click", ()=>{
  if(!isLoginOk) return alert(texts[lang].pass_required);
  const code = dom.productCodeInput_wait.value.trim();
  const qty = Math.max(1, Number(dom.productQtyInput_wait.value) || 1);
  const memo = dom.productMemoInput_wait.value.trim();
  if(!/^\d{7}$/.test(code)) return alert(texts[lang].code7);
  waitList.push({code, qty, memo, group: ""});
  saveAll(); renderWaitList();
  dom.productCodeInput_wait.value = ""; dom.productMemoInput_wait.value = "";
});

document.getElementById("groupCreateBtn").addEventListener("click", ()=>{
  const g = document.getElementById("groupNameInput").value.trim();
  if(!g) return alert(texts[lang].enter_group_name || "グループ名を入力してください");
  const boxes = Array.from(document.querySelectorAll(".selectItem:checked")).map(n=>Number(n.dataset.i));
  if(boxes.length === 0) return alert("No items selected");
  boxes.forEach(i => { if(waitList[i]) waitList[i].group = g; });
  saveAll(); renderWaitList(); document.getElementById("groupNameInput").value = "";
});

document.getElementById("decideBtn").addEventListener("click", ()=>{
  const checkedBoxes = Array.from(document.querySelectorAll(".selectItem:checked"));
  if(checkedBoxes.length === 0) return alert("No items selected");
  const indices = checkedBoxes.map(cb=>Number(cb.dataset.i)).sort((a,b)=>b-a);
  indices.forEach(i => { readyList.push({...waitList[i]}); waitList.splice(i,1); });
  saveAll(); renderAll(); alert(texts[lang].decide_ok);
});

document.getElementById("resetWaitBtn").addEventListener("click", ()=> { if(!confirm("Reset waiting list?")) return; waitList = []; saveAll(); renderAll(); });
document.getElementById("resetAllBtn").addEventListener("click", ()=> { if(!confirm("Reset ALL data?")) return; waitList=[]; readyList=[]; checkedList=[]; saveAll(); renderAll(); });
document.getElementById("resetCheckedBtn").addEventListener("click", ()=> { if(!confirm("Reset checked list?")) return; checkedList=[]; saveAll(); renderAll(); });

/* ================== OCR: 画像を入れたら即追加 ================== */
let tesseractWorker = null;
let ocrInProgress = false;
async function getWorker(){
  if(tesseractWorker) return tesseractWorker;
  tesseractWorker = Tesseract.createWorker({ logger: m => console.log(m) });
  try{
    await tesseractWorker.load();
    await tesseractWorker.loadLanguage('eng+jpn');
    await tesseractWorker.initialize('eng+jpn');
  }catch(e){
    console.warn("eng+jpn load failed, falling back to eng", e);
    try{
      await tesseractWorker.loadLanguage('eng');
      await tesseractWorker.initialize('eng');
    }catch(e2){
      console.error("OCR init failed", e2);
      throw e2;
    }
  }
  return tesseractWorker;
}

document.getElementById("ocrCaptureBtn").addEventListener("click", ()=> document.getElementById("ocrInput").click());

document.getElementById("ocrInput").addEventListener("change", async (e)=>{
  if(!isLoginOk) return alert(texts[lang].pass_required);
  const file = e.target.files[0]; e.target.value = "";
  if(!file) return;
  if(ocrInProgress) return alert("OCR busy");
  ocrInProgress = true;
  try{
    // load image, downscale if huge
    const img = new Image(); const url = URL.createObjectURL(file); img.src = url;
    await new Promise(r=> img.onload = r);
    const c = document.createElement("canvas");
    c.width = img.width; c.height = img.height;
    const ctx = c.getContext("2d"); ctx.drawImage(img,0,0);
    // downscale to max 1600px to reduce memory
    const MAX = 1600;
    let out = c;
    if(Math.max(c.width, c.height) > MAX){
      const scale = MAX / Math.max(c.width, c.height);
      const c2 = document.createElement("canvas");
      c2.width = Math.round(c.width * scale); c2.height = Math.round(c.height * scale);
      c2.getContext("2d").drawImage(c,0,0,c.width,c.height,0,0,c2.width,c2.height);
      out = c2;
    }
    const blob = await new Promise(res=> out.toBlob(res,"image/png"));
    URL.revokeObjectURL(url);

    // OCR recognize via worker (reused)
    alert("OCR中...（少し時間がかかります）");
    const worker = await getWorker();
    const { data: { text } } = await worker.recognize(blob);
    const found = (text && text.match(/\b\d{7}\b/g)) || [];
    if(found.length === 0){
      alert(texts[lang].no_hit);
    } else {
      // add all to waitList immediately (keep duplicates)
      found.forEach(c => waitList.push({code:c, qty:1, memo:"", group:""}));
      saveAll(); renderWaitList();
      alert(texts[lang].ocrAdded);
    }
  }catch(err){
    console.error("OCR error:", err);
    alert(texts[lang].ocrError);
  }finally{
    ocrInProgress = false;
  }
});

/* ================== Ready: scan input -> check (1個ずつ) ================== */
document.getElementById("scanBtnReady").addEventListener("click", ()=> handleScanCode(dom.scanInputReady.value.trim()));
dom.scanInputReady.addEventListener("keypress", (e)=>{ if(e.key === "Enter"){ handleScanCode(e.target.value.trim()); e.target.value=""; }});

function handleScanCode(code){
  if(!isLoginOk) return alert(texts[lang].pass_required);
  if(!code) return;
  // find index in readyList
  const idx = readyList.findIndex(it => it.code === code);
  if(idx === -1){
    playErrorBeep();
    return alert(texts[lang].no_hit);
  }
  const item = readyList[idx];
  checkedList.push({code:item.code, qty:1, memo:item.memo, group:item.group});
  item.qty = Number(item.qty) - 1;
  if(item.qty <= 0) readyList.splice(idx,1);
  saveAll(); renderAll(); playSuccessBeep();
}

/* ================== 初期描画 ================== */
(function init(){
  updateLangUI();
  renderAll();
  showPage("page-password");
})();
</script>
</body>
</html>
