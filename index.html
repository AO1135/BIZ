<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Indent — チェックリスト</title>
  <style>
    body { font-family: 'Noto Sans JP', sans-serif; margin: 0; background: #fff; color: #000; }
    header { 
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px; border-bottom: 1px solid #ccc; background: #f9f9f9;
      position: sticky; top: 0; z-index: 10;
    }
    h1 { font-size: 18px; margin: 0; }
    main { padding: 12px; padding-bottom: 70px; }
    button, input, select, textarea { font-size: 16px; padding: 8px; border: 1px solid #000; border-radius: 6px; box-sizing: border-box; }
    button { background: #000; color: #fff; cursor: pointer; }

    /* ▼ 下部ナビゲーション */
    nav { 
      position: fixed; bottom: 0; left: 0; right: 0; display: flex; 
      background: #000; z-index: 20;
    }
    nav button { 
      flex: 1; border: none; border-right: 1px solid #fff; 
      background: #000; color: #fff; padding: 10px;
    }
    nav button.active { background: #444; }
    nav button:last-child { border-right: none; }

    .hidden { display: none; }

    /* ▼ 各リスト行 */
    .list-item {
      border: 1px solid #000;
      padding: 8px 10px;
      margin-bottom: 6px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .item-left {
      display: flex;
      flex-direction: column;
      font-size: 14px;
      flex: 1;
    }

    /* ▼ 小ボタン */
    .small-btn {
      font-size: 13px;
      padding: 5px 8px;
      border-radius: 6px;
      background: #1976d2;
      color: #fff;
      border: none;
      cursor: pointer;
      white-space: nowrap;
      min-width: 50px;
    }
    .small-btn:hover { background: #0d47a1; }

    /* ▼ 入力サイズ調整 */
    .item-left div {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      align-items: center;
    }
    .small-input { font-size: 14px; padding: 4px; }
    .small-input.qty { width: 70px; }
    .small-input.memo { width: 100px; flex: 1; }
    .memo, .qty { font-size: 12px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body>
  <header>
    <h1 id="title">パスワード入力</h1>
    <button id="langBtn">日本語 / English</button>
  </header>

  <main>
    <!-- Password Page -->
    <section id="page-password">
      <input id="passwordInput" type="password" placeholder="パスワードを入力" />
      <button id="passwordSubmit">ログイン</button>
      <p id="passwordError" style="color:red;display:none">パスワードが違います</p>
    </section>

    <!-- Login Page -->
    <section id="page-login" class="hidden">
      <input id="userIdInput" placeholder="ユーザーIDを入力" />
      <button id="loginSubmit">ログイン</button>
    </section>

    <!-- Pre-Check List Page -->
    <section id="page-precheck" class="hidden">
      <h2 id="precheckTitle">チェック待ちリスト</h2>
      <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
        <input id="productCodeInput" placeholder="7桁のコード" />
        <input id="productQtyInput" type="number" min="1" value="1" />
        <input id="productMemoInput" placeholder="メモ" />
        <button id="addProductBtn">追加</button>
        <button id="ocrBtn">OCR追加</button>
      </div>
      <div id="precheckList"></div>
      <button id="precheckConfirm">チェックリストへ確定</button>
      <button id="precheckReset">リセット</button>
    </section>

    <!-- Checklist Page -->
    <section id="page-checklist" class="hidden">
      <h2 id="checklistTitle">チェックリスト</h2>
      <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
        <input id="searchCodeInput" placeholder="コードを検索" />
        <button id="searchBtn">検索</button>
      </div>
      <div id="checklist"></div>
      <button id="checklistReset">リセット</button>
    </section>

    <!-- Checked List Page -->
    <section id="page-checked" class="hidden">
      <h2 id="checkedTitle">チェック済みリスト</h2>
      <div id="checkedList"></div>
    </section>
  </main>

  <nav>
    <button id="navPrecheck">チェック前リスト</button>
    <button id="navChecklist">チェックリスト</button>
    <button id="navChecked">チェック済み一覧</button>
  </nav>

  <script>
    const PASSWORD = '0509';
    let lang = 'ja';

    const texts = {
      ja: { 
        passwordTitle:'パスワード入力', 
        passwordPlaceholder:'パスワードを入力', 
        loginBtn:'ログイン',
        loginTitle:'ログイン', 
        userIdPlaceholder:'ユーザーIDを入力',
        precheckTitle:'チェック待ちリスト', 
        checklistTitle:'チェックリスト', 
        checkedTitle:'チェック済みリスト', 
        wrongPass:'パスワードが違います', 
        add:'追加', 
        ocr:'OCR追加', 
        confirm:'チェックリストへ確定', 
        reset:'リセット', 
        del:'削除', 
        check:'✔',
        codePlaceholder:'7桁のコード',
        qtyLabel:'数量',
        memoPlaceholder:'メモ',
        searchPlaceholder:'コードを検索',
        searchBtn:'検索',
        notFound:'コードが見つかりません',
        navPrecheck:'チェック前リスト',
        navChecklist:'チェックリスト',
        navChecked:'チェック済み一覧',
        alertId:'IDを入力してください',
        alertCode:'7桁のコードを入力してください',
        confirmAdd:'件のコードを追加しますか？',
        noCode:'コードが検出されませんでした',
        confirmReset:'本当にリセットしますか？',
        confirmChecklistReset:'チェックリストをリセットしますか？'
      },
      en: { 
        passwordTitle:'Enter Password', 
        passwordPlaceholder:'Enter password', 
        loginBtn:'Login',
        loginTitle:'Login', 
        userIdPlaceholder:'Enter User ID',
        precheckTitle:'Pre-Check List', 
        checklistTitle:'Checklist', 
        checkedTitle:'Checked Items', 
        wrongPass:'Incorrect password', 
        add:'Add', 
        ocr:'Add via OCR', 
        confirm:'Confirm to Checklist', 
        reset:'Reset', 
        del:'Delete', 
        check:'✔',
        codePlaceholder:'7-digit code',
        qtyLabel:'Qty',
        memoPlaceholder:'Memo',
        searchPlaceholder:'Search code',
        searchBtn:'Search',
        notFound:'Code not found',
        navPrecheck:'Pre-Check',
        navChecklist:'Checklist',
        navChecked:'Checked',
        alertId:'Please enter ID',
        alertCode:'Please enter 7-digit code',
        confirmAdd:' codes found. Add them?',
        noCode:'No codes detected',
        confirmReset:'Really reset?',
        confirmChecklistReset:'Reset checklist?'
      }
    };

    const pages = ['page-login','page-precheck','page-checklist','page-checked'];

    function showPage(id){
      pages.forEach(p=>document.getElementById(p).classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      const key = id.replace('page-', '') + 'Title';
      document.getElementById('title').textContent = texts[lang][key] || '';
      document.querySelectorAll('nav button').forEach(btn=>btn.classList.remove('active'));
      if (id==='page-precheck') document.getElementById('navPrecheck').classList.add('active');
      if (id==='page-checklist') document.getElementById('navChecklist').classList.add('active');
      if (id==='page-checked') document.getElementById('navChecked').classList.add('active');
    }

    function applyLang(){
      document.getElementById('passwordInput').placeholder = texts[lang].passwordPlaceholder;
      document.getElementById('passwordSubmit').textContent = texts[lang].loginBtn;
      document.getElementById('passwordError').textContent = texts[lang].wrongPass;
      document.getElementById('userIdInput').placeholder = texts[lang].userIdPlaceholder;
      document.getElementById('loginSubmit').textContent = texts[lang].loginBtn;
      document.getElementById('productCodeInput').placeholder = texts[lang].codePlaceholder;
      document.getElementById('productMemoInput').placeholder = texts[lang].memoPlaceholder;
      document.getElementById('addProductBtn').textContent = texts[lang].add;
      document.getElementById('ocrBtn').textContent = texts[lang].ocr;
      document.getElementById('precheckConfirm').textContent = texts[lang].confirm;
      document.getElementById('precheckReset').textContent = texts[lang].reset;
      document.getElementById('searchCodeInput').placeholder = texts[lang].searchPlaceholder;
      document.getElementById('searchBtn').textContent = texts[lang].searchBtn;
      document.getElementById('checklistReset').textContent = texts[lang].reset;
      document.getElementById('navPrecheck').textContent = texts[lang].navPrecheck;
      document.getElementById('navChecklist').textContent = texts[lang].navChecklist;
      document.getElementById('navChecked').textContent = texts[lang].navChecked;
      // ページタイトルも更新
      const currentPage = pages.find(p => !document.getElementById(p).classList.contains('hidden'));
      if(currentPage) {
        const key = currentPage.replace('page-', '') + 'Title';
        document.getElementById('title').textContent = texts[lang][key] || '';
      }
      // リストを再描画
      renderPrecheck();
      renderChecklist();
      renderChecked();
    }

    document.getElementById('langBtn').addEventListener('click',()=>{
      lang=(lang==='ja')?'en':'ja';
      applyLang();
    });

    // Password
    document.getElementById('passwordSubmit').onclick=()=>{
      const val=document.getElementById('passwordInput').value;
      if(val===PASSWORD){ showPage('page-login'); }
      else{ const err=document.getElementById('passwordError'); err.style.display='block'; setTimeout(()=>err.style.display='none',2000); }
    };

    // Login
    document.getElementById('loginSubmit').onclick=()=>{
      const id=document.getElementById('userIdInput').value.trim();
      if(!id) return alert(texts[lang].alertId);
      localStorage.setItem('indent:user',id);
      showPage('page-precheck');
    };

    let precheckList = JSON.parse(localStorage.getItem('indent:precheck')||'[]');
    let checklist = JSON.parse(localStorage.getItem('indent:checklist')||'[]');
    let checkedList = JSON.parse(localStorage.getItem('indent:checked')||'[]');

    function saveData(){
      localStorage.setItem('indent:precheck',JSON.stringify(precheckList));
      localStorage.setItem('indent:checklist',JSON.stringify(checklist));
      localStorage.setItem('indent:checked',JSON.stringify(checkedList));
    }

    function renderPrecheck(){
      const el=document.getElementById('precheckList'); el.innerHTML='';
      precheckList.forEach((item,i)=>{
        const div=document.createElement('div');
        div.className='list-item';
        div.innerHTML=`
          <div class="item-left">
            <span>${item.code}</span>
            <div>
              ${texts[lang].qtyLabel}: <input type='number' class='small-input qty' data-i='${i}' value='${item.qty}' min='1'>
              <input type='text' class='small-input memo' data-i='${i}' value='${item.memo||''}' placeholder='${texts[lang].memoPlaceholder}'>
            </div>
          </div>
          <button data-i='${i}' class='small-btn removeBtn'>${texts[lang].del}</button>`;
        el.appendChild(div);
      });
      document.querySelectorAll('.removeBtn').forEach(btn=>btn.onclick=e=>{
        precheckList.splice(e.target.dataset.i,1); saveData(); renderPrecheck();
      });
      document.querySelectorAll('.qty').forEach(input=>input.onchange=e=>{
        precheckList[e.target.dataset.i].qty=Number(e.target.value); saveData();
      });
      document.querySelectorAll('.memo').forEach(input=>input.onchange=e=>{
        precheckList[e.target.dataset.i].memo=e.target.value; saveData();
      });
    }

    function renderChecklist(){
      const el=document.getElementById('checklist'); el.innerHTML='';
      checklist.forEach((item,i)=>{
        const div=document.createElement('div');
        div.className='list-item';
        div.id=`checklist-item-${i}`;
        div.innerHTML=`
          <div class="item-left">
            <span>${item.code} ×${item.qty}</span>
            ${item.memo ? `<span class="memo">${item.memo}</span>` : ''}
          </div>
          <button data-i='${i}' class='small-btn checkBtn'>${texts[lang].check}</button>`;
        el.appendChild(div);
      });
      document.querySelectorAll('.checkBtn').forEach(btn=>btn.onclick=e=>{
        const i=e.target.dataset.i;
        if(checklist[i].qty>1){ checklist[i].qty--; checkedList.push({code:checklist[i].code,qty:1,memo:checklist[i].memo}); }
        else { checkedList.push(checklist[i]); checklist.splice(i,1); }
        saveData(); renderChecklist(); renderChecked();
      });
    }

    function renderChecked(){
      const el=document.getElementById('checkedList'); el.innerHTML='';
      const grouped = {};
      checkedList.forEach(it=>{ 
        if(grouped[it.code]) {
          grouped[it.code].qty+=it.qty;
          // メモを統合（既存と新規のメモを両方保持）
          if(it.memo && !grouped[it.code].memo.includes(it.memo)) {
            grouped[it.code].memo = grouped[it.code].memo ? `${grouped[it.code].memo}, ${it.memo}` : it.memo;
          }
        } else {
          grouped[it.code]={...it};
        }
      });
      const groupedArray = Object.values(grouped);
      groupedArray.forEach((it, i)=>{
        const div=document.createElement('div');
        div.className='list-item';
        div.innerHTML=`
          <div class="item-left">
            <span>${it.code} ×${it.qty}</span>
            ${it.memo?`<span class="memo">${it.memo}</span>`:''}
          </div>
          <button data-i='${i}' class='small-btn removeCheckedBtn'>${texts[lang].del}</button>`;
        el.appendChild(div);
      });
      document.querySelectorAll('.removeCheckedBtn').forEach(btn=>btn.onclick=e=>{
        const code = groupedArray[e.target.dataset.i].code;
        checkedList = checkedList.filter(it => it.code !== code);
        saveData(); renderChecked();
      });
    }

    document.getElementById('addProductBtn').onclick=()=>{
      const code=document.getElementById('productCodeInput').value.trim();
      const qty=Number(document.getElementById('productQtyInput').value)||1;
      const memo=document.getElementById('productMemoInput').value.trim();
      if(!/^\d{7}$/.test(code)) return alert(texts[lang].alertCode);
      precheckList.push({code,qty,memo}); saveData(); renderPrecheck();
      document.getElementById('productCodeInput').value=''; document.getElementById('productMemoInput').value='';
    };

    document.getElementById('ocrBtn').onclick=()=>{
      const input=document.createElement('input'); input.type='file'; input.accept='image/*'; input.capture='environment';
      input.onchange=async(e)=>{
        const file=e.target.files[0];
        if(!file) return;
        const result=await Tesseract.recognize(file,'eng',{ tessedit_char_whitelist:'0123456789' });
        const codes=result.data.text.match(/\d{7}/g)||[];
        if(codes.length){
          if(confirm(`${codes.length}${texts[lang].confirmAdd}`)){
            codes.forEach(c=>precheckList.push({code:c,qty:1,memo:''}));
            saveData(); renderPrecheck();
          }
        }else{
          alert(texts[lang].noCode);
        }
      };
      input.click();
    };

    document.getElementById('precheckConfirm').onclick=()=>{ checklist.push(...precheckList); precheckList=[]; saveData(); renderPrecheck(); renderChecklist(); showPage('page-checklist'); };

    document.getElementById('searchBtn').onclick=()=>{
      const searchCode = document.getElementById('searchCodeInput').value.trim();
      if(!searchCode) return;
      
      // チェックリストから検索
      const index = checklist.findIndex(item => item.code === searchCode);
      if(index !== -1) {
        // 見つかった項目にスクロールしてハイライト
        const element = document.getElementById(`checklist-item-${index}`);
        if(element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
          element.style.backgroundColor = '#ffeb3b';
          setTimeout(() => { element.style.backgroundColor = ''; }, 2000);
        }
        document.getElementById('searchCodeInput').value = '';
      } else {
        alert(texts[lang].notFound);
      }
    };

    // Enterキーでも検索できるように
    document.getElementById('searchCodeInput').addEventListener('keypress', (e) => {
      if(e.key === 'Enter') {
        document.getElementById('searchBtn').click();
      }
    });

    document.getElementById('precheckReset').onclick=()=>{ if(confirm(texts[lang].confirmReset)){ precheckList=[]; saveData(); renderPrecheck(); } };
    document.getElementById('checklistReset').onclick=()=>{ if(confirm(texts[lang].confirmChecklistReset)){ checklist=[]; saveData(); renderChecklist(); } };

    document.getElementById('navPrecheck').onclick = () => showPage('page-precheck');
    document.getElementById('navChecklist').onclick = () => showPage('page-checklist');
    document.getElementById('navChecked').onclick = () => showPage('page-checked');

    renderPrecheck(); renderChecklist(); renderChecked();
    applyLang();
  </script>
</body>
</html>
