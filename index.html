<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Indent — チェックリスト</title>
  <style>
    body { font-family:'Noto Sans JP',sans-serif; margin:0; background:#fff; color:#000; }
    header{display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #ccc;}
    h1{font-size:18px; margin:0;}
    main{padding:12px;}
    button,input,textarea{font-size:16px;padding:8px;border:1px solid #000;border-radius:6px; box-sizing:border-box;}
    button{background:#000;color:#fff; cursor:pointer;}
    nav{position:fixed;bottom:0;left:0;right:0;display:flex;background:#000;}
    nav button{flex:1;border:none;border-right:1px solid #fff; padding:10px;}
    nav button:last-child{border-right:none;}
    .hidden{display:none;}
    .list-item{border:1px solid #000;padding:6px;margin-bottom:6px;border-radius:6px; display:flex; flex-wrap:wrap; gap:6px; align-items:center;}
    .memo, .qty{font-size:12px;margin-left:4px;}
    .small-input{width:60px;}
    .large-memo{width:100%; height:50px; margin-top:4px;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body>
<header>
  <h1 id="title">パスワード入力</h1>
  <button id="langBtn">日本語 / English</button>
</header>
<main>
  <!-- Password -->
  <section id="page-password">
    <input id="passwordInput" type="password" placeholder="パスワードを入力" />
    <button id="passwordSubmit">ログイン</button>
    <p id="passwordError" style="color:red;display:none">パスワードが違います</p>
  </section>

  <!-- Login -->
  <section id="page-login" class="hidden">
    <input id="userIdInput" placeholder="ユーザーIDを入力" />
    <button id="loginSubmit">ログイン</button>
  </section>

  <!-- Pre-Check List -->
  <section id="page-precheck" class="hidden">
    <h2 id="precheckTitle">チェック待ちリスト</h2>
    <div style="display:flex; gap:6px; flex-wrap:wrap;">
      <input id="productCodeInput" placeholder="7桁コード">
      <input id="productQtyInput" type="number" min="1" value="1">
      <input id="productMemoInput" placeholder="メモ">
      <button id="addProductBtn">追加</button>
      <button id="ocrBtn">OCR追加</button>
    </div>
    <div id="precheckList"></div>
    <button id="precheckConfirm">チェックリストへ確定</button>
    <button id="precheckReset">リセット</button>
  </section>

  <!-- Checklist -->
  <section id="page-checklist" class="hidden">
    <h2 id="checklistTitle">チェックリスト</h2>
    <input id="checkInput" placeholder="番号入力 or バーコード">
    <div id="checklist"></div>
    <button id="checklistReset">リセット</button>
  </section>

  <!-- Checked -->
  <section id="page-checked" class="hidden">
    <h2 id="checkedTitle">チェック済みリスト</h2>
    <div id="checkedList"></div>
  </section>
</main>

<nav>
  <button id="navPrecheck">チェック待ち</button>
  <button id="navChecklist">チェックリスト</button>
  <button id="navChecked">チェック済み</button>
</nav>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const PASSWORD='0509'; let lang='ja';
  const texts={ja:{passwordTitle:'パスワード入力',passwordPlaceholder:'パスワードを入力',precheckTitle:'チェック待ちリスト',checklistTitle:'チェックリスト',checkedTitle:'チェック済みリスト',wrongPass:'パスワードが違います',add:'追加',ocr:'OCR追加',confirm:'チェックリストへ確定',reset:'リセット'},en:{passwordTitle:'Enter Password',passwordPlaceholder:'Enter password',precheckTitle:'Pre-Check List',checklistTitle:'Checklist',checkedTitle:'Checked Items',wrongPass:'Incorrect password',add:'Add',ocr:'Add via OCR',confirm:'Confirm to Checklist',reset:'Reset'}};
  
  const pages=['page-precheck','page-checklist','page-checked'];

  let precheckList=JSON.parse(localStorage.getItem('indent:precheck')||'[]');
  let checklist=JSON.parse(localStorage.getItem('indent:checklist')||'[]');
  let checkedList=JSON.parse(localStorage.getItem('indent:checked')||'[]');

  function saveData(){localStorage.setItem('indent:precheck',JSON.stringify(precheckList)); localStorage.setItem('indent:checklist',JSON.stringify(checklist)); localStorage.setItem('indent:checked',JSON.stringify(checkedList));}

  function showPage(id){
    pages.forEach(p=>document.getElementById(p).classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    if(id==='page-precheck') document.getElementById('title').textContent=texts[lang].precheckTitle;
    if(id==='page-checklist') document.getElementById('title').textContent=texts[lang].checklistTitle;
    if(id==='page-checked') document.getElementById('title').textContent=texts[lang].checkedTitle;
  }

  function applyLang(){
    document.getElementById('passwordInput').placeholder=texts[lang].passwordPlaceholder;
    document.getElementById('passwordError').textContent=texts[lang].wrongPass;
    document.getElementById('addProductBtn').textContent=texts[lang].add;
    document.getElementById('ocrBtn').textContent=texts[lang].ocr;
    document.getElementById('precheckConfirm').textContent=texts[lang].confirm;
    document.getElementById('precheckReset').textContent=texts[lang].reset;
    document.getElementById('checklistReset').textContent=texts[lang].reset;
  }
  document.getElementById('langBtn').addEventListener('click',()=>{lang=lang==='ja'?'en':'ja'; applyLang();});

  // --- Password ---
  document.getElementById('passwordSubmit').addEventListener('click',()=>{
    const val=document.getElementById('passwordInput').value;
    if(val===PASSWORD) showPage('page-login');
    else { const err=document.getElementById('passwordError'); err.style.display='block'; setTimeout(()=>err.style.display='none',2000);}
  });

  // --- Login ---
  document.getElementById('loginSubmit').addEventListener('click',()=>{
    const id=document.getElementById('userIdInput').value.trim();
    if(!id) return alert('IDを入力してください');
    localStorage.setItem('indent:user',id);
    showPage('page-precheck');
  });

  // --- Precheck ---
  document.getElementById('addProductBtn').addEventListener('click',()=>{
    const code=document.getElementById('productCodeInput').value.trim();
    const qty=Number(document.getElementById('productQtyInput').value)||1;
    const memo=document.getElementById('productMemoInput').value.trim();
    if(!/^\d{7}$/.test(code)) return alert('7桁コードを入力');
    precheckList.push({code,qty,memo}); saveData(); renderPrecheck();
    document.getElementById('productCodeInput').value=''; document.getElementById('productMemoInput').value='';
  });

  document.getElementById('ocrBtn').addEventListener('click',()=>{
    const input=document.createElement('input'); input.type='file'; input.accept='image/*'; input.capture='environment';
    input.onchange=async(e)=>{
      const file=e.target.files[0]; if(!file) return;
      const result=await Tesseract.recognize(file,'eng',{tessedit_char_whitelist:'0123456789'});
      const codes=result.data.text.match(/\d{7}/g)||[];
      codes.forEach(c=>precheckList.push({code:c,qty:1,memo:''}));
      saveData(); renderPrecheck();
    }; input.click();
  });

  document.getElementById('precheckConfirm').addEventListener('click',()=>{
    checklist.push(...precheckList); precheckList.length=0;
    saveData(); renderPrecheck(); renderChecklist(); showPage('page-checklist');
  });
  document.getElementById('precheckReset').addEventListener('click',()=>{ precheckList=[]; saveData(); renderPrecheck(); });
  document.getElementById('checklistReset').addEventListener('click',()=>{ checklist=[]; saveData(); renderChecklist(); });

  // --- Checklist input (手入力 or バーコード) ---
  document.getElementById('checkInput').addEventListener('change',()=>{
    const code=document.getElementById('checkInput').value.trim();
    const idx=checklist.findIndex(it=>it.code===code);
    if(idx===-1){ alert('該当なし'); return; }
    const item=checklist[idx];
    if(item.qty>1){
      const q=Number(prompt(`数量を入力（1〜${item.qty}）`,1));
      if(isNaN(q)||q<1||q>item.qty) return;
      item.qty-=q;
      checkedList.push({code:item.code,qty:q,memo:item.memo});
      if(item.qty===0) checklist.splice(idx,1);
    } else { checkedList.push(item); checklist.splice(idx,1); }
    renderChecklist(); renderChecked(); playSound('success');
    document.getElementById('checkInput').value='';
  });

  // --- Navigation ---
  document.getElementById('navPrecheck').addEventListener('click',()=>showPage('page-precheck'));
  document.getElementById('navChecklist').addEventListener('click',()=>showPage('page-checklist'));
  document.getElementById('navChecked').addEventListener('click',()=>showPage('page-checked'));

  // --- Render Functions ---
  function renderPrecheck(){
    const el=document.getElementById('precheckList'); el.innerHTML='';
    precheckList.forEach((item,i)=>{
      const div=document.createElement('div'); div.className='list-item';
      div.innerHTML=`${item.code} <input type='number' class='small-input qty' data-i='${i}' value='${item.qty}'> <input type='text' class='small-input memo' data-i='${i}' value='${item.memo||''}' placeholder='メモ'> <button class='removeBtn' data-i='${i}'>削除</button>`;
      el.appendChild(div);
    });
  }

  function renderChecklist(){
    const el=document.getElementById('checklist'); el.innerHTML='';
    checklist.forEach((item,i)=>{
      const div=document.createElement('div'); div.className='list-item';
      div.innerHTML=`${item.code} ×${item
